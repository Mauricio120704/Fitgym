<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pago de Clase - FitGym</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
    <link rel="stylesheet" th:href="@{/Estilos/checkout.css}">
</head>
<body>
    <div class="checkout-container">
        <h1 class="checkout-title">Pagar Clase</h1>
        <p class="checkout-subtitle">Completa tu pago de forma segura para reservar la clase</p>

        <div class="row">
            <div class="col-lg-5 mb-4">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-receipt"></i>
                        Resumen de la Clase
                    </div>
                    <div class="card-body">
                        <div class="order-summary-item">
                            <span class="label">Clase</span>
                            <span class="value" th:text="${clase.nombre}">Nombre de la clase</span>
                        </div>
                        <div class="order-summary-item">
                            <span class="label">Fecha</span>
                            <span class="value" th:text="${#temporals.format(clase.fecha, 'dd/MM/yyyy HH:mm')}">01/01/2025 10:00</span>
                        </div>
                        <div class="order-summary-item">
                            <span class="label">Instructor</span>
                            <span class="value" th:text="${clase.entrenador != null ? clase.entrenador.nombre : '-'}">Instructor</span>
                        </div>

                        <div class="order-summary-item">
                            <span class="label"></span>
                            <span class="value fw-bold">S/ <span th:text="${precio}">0.00</span></span>
                        </div>

                        <div th:if="${precioConDescuento != null}" class="order-summary-item">
                            <span class="label text-success">Precio con promoción</span>
                            <span class="value fw-bold text-success">S/ <span th:text="${precioConDescuento}">0.00</span></span>
                        </div>

                        <div class="order-total">
                            <span>Total a Pagar</span>
                            <span>
                                <span th:if="${precioConDescuento != null}">
                                    S/ <span th:text="${precioConDescuento}">0.00</span>
                                </span>
                                <span th:if="${precioConDescuento == null}">
                                    S/ <span th:text="${precio}">0.00</span>
                                </span>
                            </span>
                        </div>

                        <div class="security-note">
                            <i class="fas fa-lock"></i>
                            <span>Pago 100% seguro con encriptación SSL</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-7">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-credit-card"></i>
                        Información de Pago
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-4">Serás redirigido a una página de pago segura de Stripe para completar tu compra.</p>

                        <form id="checkout-clase-form" action="#" method="post">
                            <input type="hidden" name="claseId" th:value="${claseId}">
                            <input type="hidden" name="usuario" th:value="${usuario}">
                            <input type="hidden" name="precio" th:value="${precio}">
                            <input type="hidden" name="promoId" th:value="${promoId}">

                            <div class="action-buttons">
                                <button type="button" class="btn btn-outline-secondary" 
                                        th:onclick="|location.href='@{/reservas}'|">
                                    Volver
                                </button>
                                <button type="submit" class="btn btn-custom-orange">
                                    Pagar con Stripe
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script th:inline="javascript">
        const stripePublicKey = /*[[${stripePublishableKey}]]*/ '';
        const stripe = stripePublicKey ? Stripe(stripePublicKey) : null;

        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('checkout-clase-form');
            if (!form) {
                return;
            }

            form.addEventListener('submit', function (e) {
                e.preventDefault();

                if (!stripe) {
                    alert('El pago con Stripe no está disponible en este momento. Contacta con el administrador.');
                    return;
                }

                const claseId = form.querySelector('input[name="claseId"]').value;
                const usuario = form.querySelector('input[name="usuario"]').value;
                const precio = form.querySelector('input[name="precio"]').value;
                const promoIdInput = form.querySelector('input[name="promoId"]');
                const promoId = promoIdInput ? promoIdInput.value : '';

                const params = new URLSearchParams({ claseId, usuario, precio, promoId });

                fetch('/checkout/clase/create-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
                    },
                    body: params.toString()
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert(data.error);
                            return;
                        }

                        if (data.id) {
                            stripe.redirectToCheckout({ sessionId: data.id });
                        }
                    })
                    .catch(error => {
                        console.error('Error al crear sesión de Stripe para clase', error);
                        alert('No se pudo iniciar el pago de la clase. Intenta nuevamente.');
                    });
            });
        });
    </script>
</body>
</html>
