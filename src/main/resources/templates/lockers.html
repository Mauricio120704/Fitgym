<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Lockers - Sistema de Gimnasio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/Estilos/sidebar-common.css}">
    <script>
        // Aplicar estado del sidebar INMEDIATAMENTE antes de renderizar
        (function() {
            const expanded = localStorage.getItem('sidebarExpanded') === 'true';
            if (expanded) {
                document.documentElement.style.setProperty('--sidebar-width', '16rem');
            } else {
                document.documentElement.style.setProperty('--sidebar-width', '5rem');
            }
        })();

        // Array para almacenar los lockers
        let lockers = [];

        // Función para formatear la fecha
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Función para cargar los lockers desde el backend
        async function loadLockers() {
            try {
                const response = await fetch('/api/lockers');
                if (!response.ok) {
                    throw new Error('Error al cargar los lockers');
                }
                const data = await response.json();
                lockers = data.map(locker => ({
                    id: locker.id,
                    number: locker.numero,
                    status: locker.estado === 'DISPONIBLE' ? 'available' : 'occupied',
                    user: locker.personaAsignada ?
                        `${locker.personaAsignada.nombre} ${locker.personaAsignada.apellido}` : null,
                    assignmentDate: locker.fechaAsignacion ? formatDate(locker.fechaAsignacion) : null,
                    rawData: locker // Almacenar los datos completos para referencia
                }));

                // Actualizar la interfaz de usuario
                updateLockersUI();

                // Actualizar el contador de lockers
                updateLockerCounters();
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar los lockers. Por favor, intente de nuevo.');
            }
        }

        // Función para actualizar los contadores de lockers
        function updateLockerCounters() {
            const totalLockers = lockers.length;
            const availableLockers = lockers.filter(l => l.status === 'available').length;
            const occupiedLockers = totalLockers - availableLockers;

            document.getElementById('totalLockers').textContent = totalLockers;
            document.getElementById('availableLockers').textContent = availableLockers;
            document.getElementById('occupiedLockers').textContent = occupiedLockers;
        }

        function openAssignModal(lockerNumber) {
            document.getElementById('lockerNumber').textContent = lockerNumber;
            document.getElementById('assignLockerNumber').value = lockerNumber;
            document.getElementById('assignLockerModal').classList.remove('hidden');
            document.getElementById('searchMember').focus();
            // Limpiar resultados de búsqueda anteriores
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('selectedMember').textContent = 'Ningún miembro seleccionado';
            document.getElementById('assignButton').disabled = true;
            document.getElementById('searchMember').value = '';
        }

        function closeAssignModal() {
            document.getElementById('assignLockerModal').classList.add('hidden');
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('searchMember').value = '';
        }

        async function searchMember() {
            const searchTerm = document.getElementById('searchMember').value.trim();
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '';

            if (searchTerm.length === 0) {
                resultsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Ingrese un nombre para buscar</p>';
                return;
            }

            try {
                const response = await fetch(`/api/lockers/buscar-personas?termino=${encodeURIComponent(searchTerm)}`);
                if (!response.ok) {
                    throw new Error('Error al buscar miembros');
                }
                const results = await response.json();

                if (results.length === 0) {
                    resultsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No se encontraron resultados</p>';
                    return;
                }

                results.forEach(member => {
                    const memberElement = document.createElement('div');
                    memberElement.className = 'p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-200';
                    memberElement.innerHTML = `
                        <div class="font-medium">${member.nombreCompleto}</div>
                        <div class="text-sm text-gray-600">DNI: ${member.dni}</div>
                        <div class="text-sm text-gray-600">${member.tipoMembresia}</div>
                    `;
                    memberElement.onclick = () => selectMember({
                        id: member.id,
                        name: member.nombreCompleto,
                        dni: member.dni
                    });
                    resultsContainer.appendChild(memberElement);
                });
            } catch (error) {
                console.error('Error:', error);
                resultsContainer.innerHTML = '<p class="text-red-500 text-center py-4">Error al buscar miembros. Intente de nuevo.</p>';
            }
        }

        function selectMember(member) {
            document.getElementById('selectedMember').textContent = `Seleccionado: ${member.name}`;
            const assignButton = document.getElementById('assignButton');
            assignButton.disabled = false;
            assignButton.setAttribute('data-member-id', member.id);
        }

        async function assignLocker() {
            const lockerNumber = document.getElementById('assignLockerNumber').value;
            const memberId = document.getElementById('assignButton').getAttribute('data-member-id');

            if (!memberId) {
                alert('Por favor seleccione un miembro');
                return;
            }

            try {
                const response = await fetch('/api/lockers/asignar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `numeroLocker=${encodeURIComponent(lockerNumber)}&personaId=${encodeURIComponent(memberId)}`
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Error al asignar el locker');
                }

                // Cerrar el modal y actualizar la lista de lockers
                closeAssignModal();
                loadLockers();

                // Mostrar notificación de éxito
                alert(`Locker ${lockerNumber} asignado correctamente`);
            } catch (error) {
                console.error('Error:', error);
                alert(error.message || 'Error al asignar el locker. Por favor, intente de nuevo.');
            }
        }

        async function releaseLocker(lockerNumber) {
            if (!confirm(`¿Está seguro de liberar el locker ${lockerNumber}?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/lockers/liberar/${encodeURIComponent(lockerNumber)}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Error al liberar el locker');
                }

                // Actualizar la lista de lockers
                loadLockers();

                // Mostrar notificación de éxito
                alert(`Locker ${lockerNumber} ha sido liberado correctamente`);
            } catch (error) {
                console.error('Error:', error);
                alert(error.message || 'Error al liberar el locker. Por favor, intente de nuevo.');
            }
        }

        // Función para actualizar la interfaz de usuario de los lockers
        function updateLockersUI() {
            const grid = document.getElementById('lockersGrid');
            grid.innerHTML = ''; // Limpiar la cuadrícula

            if (lockers.length === 0) {
                grid.innerHTML = '<p class="col-span-full text-center py-8 text-gray-500">No hay lockers disponibles</p>';
                return;
            }

            // Ordenar lockers por número
            const sortedLockers = [...lockers].sort((a, b) => {
                return a.number.localeCompare(b.number, undefined, {numeric: true, sensitivity: 'base'});
            });

            sortedLockers.forEach(locker => {
                const lockerElement = document.createElement('div');
                lockerElement.className = `locker-item relative ${
                    locker.status === 'available'
                        ? 'bg-green-100 hover:bg-green-200 cursor-pointer'
                        : 'bg-red-100 hover:bg-red-200 cursor-pointer'
                }`;

                if (locker.status === 'available') {
                    lockerElement.onclick = () => openAssignModal(locker.number);
                    lockerElement.innerHTML = `
                        <div class="text-2xl font-bold text-gray-800">${locker.number}</div>
                        <div class="mt-2 px-3 py-1 bg-green-500 text-white text-xs rounded-full">DISPONIBLE</div>
                    `;
                } else {
                    lockerElement.onclick = () => releaseLocker(locker.number);
                    lockerElement.innerHTML = `
                        <div class="text-2xl font-bold text-gray-800">${locker.number}</div>
                        <div class="mt-1 text-sm font-medium text-center">${locker.user}</div>
                        <div class="mt-1 text-xs text-gray-600">${locker.assignmentDate}</div>
                        <div class="mt-1 px-3 py-1 bg-red-500 text-white text-xs rounded-full">OCUPADO</div>
                    `;
                }

                grid.appendChild(lockerElement);
            });
        }

        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar los lockers al iniciar
            loadLockers();

            // Configurar el evento de búsqueda con debounce
            let searchTimeout;
            document.getElementById('searchMember').addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(searchMember, 300);
            });

            // Configurar el botón de asignar
            document.getElementById('assignButton').addEventListener('click', assignLocker);
        });
    </script>
    <style>
        .locker-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        @media (max-width: 1024px) {
            .locker-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .locker-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .locker-grid {
                grid-template-columns: 1fr;
            }
        }

        .locker-item {
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }

        .locker-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="flex h-screen bg-gray-200">
        <!-- Sidebar -->
        <div th:replace="~{fragments/sidebar :: sidebar('lockers')}"></div>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex justify-between items-center p-4 bg-white border-b shadow-sm">
                <div class="flex items-center gap-4">
                    <button id="menu-button" class="text-gray-600 hover:text-gray-800 focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <h1 class="text-xl font-semibold text-gray-800">
                        <i class="fas fa-lock mr-2"></i>Gestión de Lockers
                    </h1>
                </div>
                <div class="flex items-center gap-4 invisible">
                    <div class="relative">
                        <button class="text-gray-600 hover:text-gray-800 focus:outline-none">
                            <i class="fas fa-bell text-xl"></i>
                        </button>
                        <span class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">3</span>
                    </div>
                    <div class="h-8 w-px bg-gray-300"></div>
                    <div class="flex items-center">
                        <i class="fas fa-user-circle text-2xl text-gray-600"></i>
                    </div>
                </div>
            </header>

            <!-- Contenido principal -->
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                <div class="container mx-auto">
                    <!-- Resumen de lockers -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                    <i class="fas fa-lock text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-500">Total Lockers</p>
                                    <p id="totalLockers" class="text-2xl font-semibold text-gray-800">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-green-100 text-green-600">
                                    <i class="fas fa-unlock text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-500">Disponibles</p>
                                    <p id="availableLockers" class="text-2xl font-semibold text-green-600">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-red-100 text-red-600">
                                    <i class="fas fa-lock text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-500">Ocupados</p>
                                    <p id="occupiedLockers" class="text-2xl font-semibold text-red-600">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cuadrícula de lockers -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-semibold text-gray-800">Lockers</h2>
                            <div class="flex items-center space-x-2">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 rounded-full bg-green-500 mr-1"></div>
                                    <span class="text-xs text-gray-600">Disponible</span>
                                </div>
                                <div class="flex items-center ml-2">
                                    <div class="w-3 h-3 rounded-full bg-red-500 mr-1"></div>
                                    <span class="text-xs text-gray-600">Ocupado</span>
                                </div>
                            </div>
                        </div>

                        <div id="lockersGrid" class="locker-grid">
                            <!-- Los lockers se generarán dinámicamente con JavaScript -->
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal para asignar locker -->
    <div id="assignLockerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-md mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Asignar Locker <span id="lockerNumber"></span></h3>
                    <button onclick="closeAssignModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="mb-4">
                    <label for="searchMember" class="block text-sm font-medium text-gray-700 mb-1">Buscar deportista</label>
                    <input type="text" id="searchMember" oninput="searchMember()"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Ingrese nombre o apellido">
                    <div id="searchResults" class="mt-2 border border-gray-200 rounded-md max-h-48 overflow-y-auto">
                        <p class="text-gray-500 text-center py-4">Ingrese un nombre para buscar</p>
                    </div>
                </div>

                <div id="selectedMember" class="mb-4 p-3 bg-gray-50 rounded-md text-sm">
                    No se ha seleccionado ningún miembro
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="closeAssignModal()"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button id="assignButton"
                            onclick="assignLocker()"
                            disabled
                            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                        Asignar Locker
                    </button>
                </div>

                <input type="hidden" id="assignLockerNumber">
            </div>
        </div>
    </div>

    <script th:src="@{/sidebar.js}"></script>
</body>
</html>
