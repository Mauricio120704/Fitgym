<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoreo de Capacidad - Gimnasio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/Estilos/sidebar-common.css}">
    <script>
        (function() {
            const expanded = localStorage.getItem('sidebarExpanded') === 'true';
            if (expanded) {
                document.documentElement.style.setProperty('--sidebar-width', '16rem');
            } else {
                document.documentElement.style.setProperty('--sidebar-width', '5rem');
            }
        })();
    </script>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div th:replace="~{fragments/sidebar :: sidebar('monitoreo-capacidad')}"></div>

        <!-- Main Content -->
        <div class="flex-1 overflow-auto">
          <header class="flex justify-between items-center p-4 bg-white border-b shadow-sm">
            <div class="flex items-center gap-4">
              <button id="menu-button" class="text-gray-600 hover:text-gray-800 focus:outline-none">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
              </button>
              <div class="text-xl font-semibold text-gray-800">Monitoreo de Capacidad</div>
            </div>
            <div></div>
          </header>
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">Monitoreo de Capacidad</h1>
                    <div class="text-sm text-gray-500">
                        <span id="lastUpdated">Actualizado: <span th:text="${#temporals.format(#temporals.createNow(), 'dd/MM/yyyy HH:mm:ss')}"></span></span>
                    </div>
                </div>

                <!-- Capacidad Actual -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-gray-700">Estado de Aforo</h2>
                        <button onclick="actualizarCapacidad()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>Actualizar
                        </button>
                    </div>

                    <div class="mb-6">
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-medium text-gray-700">Capacidad: <span id="personasActuales">0</span>/50 personas</span>
                            <span id="porcentajeOcupacion" class="text-sm font-medium">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-6">
                            <div id="barraProgreso" class="bg-blue-600 h-6 rounded-full text-center text-white text-xs leading-6 transition-all duration-500"
                                 style="width: 0%;">
                                0%
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Tarjeta de Capacidad -->
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-full mr-4">
                                    <i class="fas fa-users text-blue-600 text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Personas en el gimnasio</p>
                                    <p class="text-2xl font-bold text-blue-700" id="contadorPersonas">0</p>
                                </div>
                            </div>
                        </div>

                        <!-- Tarjeta de Estado -->
                        <div class="bg-green-50 p-4 rounded-lg border border-green-100">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-full mr-4">
                                    <i class="fas fa-check-circle text-green-600 text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Estado</p>
                                    <p class="text-2xl font-bold text-green-700" id="estadoGimnasio">Disponible</p>
                                </div>
                            </div>
                        </div>

                        <!-- Tarjeta de Capacidad Restante -->
                        <div class="bg-amber-50 p-4 rounded-lg border border-amber-100">
                            <div class="flex items-center">
                                <div class="p-3 bg-amber-100 rounded-full mr-4">
                                    <i class="fas fa-tachometer-alt text-amber-600 text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Espacios disponibles</p>
                                    <p class="text-2xl font-bold text-amber-700" id="espaciosDisponibles">50</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráfico de Uso por Hora -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-lg font-semibold text-gray-700 mb-4">Histórico de Uso (Hoy)</h2>
                    <div class="h-64 flex items-end space-x-1" id="graficoBarras">
                        <!-- Las barras se generarán con JavaScript -->
                    </div>
                    <div class="flex justify-between mt-2 text-xs text-gray-500">
                        <span>8:00</span>
                        <span>12:00</span>
                        <span>16:00</span>
                        <span>20:00</span>
                    </div>
                </div>

                <!-- Últimos Registros -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-lg font-semibold text-gray-700 mb-4">Últimos Registros</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hora</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Persona</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                </tr>
                            </thead>
                            <tbody id="ultimosRegistros" class="bg-white divide-y divide-gray-200">
                                <!-- Los registros se cargarán con JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script th:src="@{/sidebar.js}"></script>
    <script th:inline="javascript">
        // Datos de ejemplo (en un caso real, estos vendrían de una API)
        let capacidadMaxima = 50;
        let personasActuales = 0;
        let ultimosRegistros = [];

        // Función para actualizar la capacidad
        function actualizarCapacidad() {
            // Realizar una llamada a la API para obtener los datos actuales
            fetch('/monitoreo/api/capacidad')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Datos recibidos:', data);
                    actualizarVista(data);
                    actualizarUltimaActualizacion();
                })
                .catch(error => {
                    console.error('Error al actualizar la capacidad:', error);
                    // Mostrar mensaje de error al usuario
                    mostrarMensaje('Error al cargar los datos. Recargando...', 'error');
                    // Recargar después de 5 segundos
                    setTimeout(() => location.reload(), 5000);
                });
        }

        // Función para actualizar la vista con los datos
        function actualizarVista(data) {
            try {
                // Validar datos recibidos
                if (!data) {
                    throw new Error('No se recibieron datos');
                }

                const personasActuales = data.personasActuales || 0;
                const registrosRecientes = data.registrosRecientes || [];
                const datosGrafico = data.datosGrafico || {};

                // Actualizar contadores
                document.getElementById('personasActuales').textContent = personasActuales;
                document.getElementById('contadorPersonas').textContent = personasActuales;

                // Calcular porcentaje de ocupación
                const porcentaje = Math.round((personasActuales / capacidadMaxima) * 100);
                document.getElementById('porcentajeOcupacion').textContent = porcentaje + '%';

                // Actualizar barra de progreso
                const barraProgreso = document.getElementById('barraProgreso');
                barraProgreso.style.width = porcentaje + '%';
                barraProgreso.textContent = porcentaje + '%';

                // Cambiar color según el nivel de ocupación
                if (porcentaje >= 90) {
                    barraProgreso.className = 'bg-red-600 h-6 rounded-full text-center text-white text-xs leading-6 transition-all duration-500';
                    document.getElementById('estadoGimnasio').textContent = 'Lleno';
                    document.getElementById('estadoGimnasio').className = 'text-2xl font-bold text-red-700';
                } else if (porcentaje >= 70) {
                    barraProgreso.className = 'bg-yellow-500 h-6 rounded-full text-center text-white text-xs leading-6 transition-all duration-500';
                    document.getElementById('estadoGimnasio').textContent = 'Alta demanda';
                    document.getElementById('estadoGimnasio').className = 'text-2xl font-bold text-yellow-600';
                } else {
                    barraProgreso.className = 'bg-green-500 h-6 rounded-full text-center text-white text-xs leading-6 transition-all duration-500';
                    document.getElementById('estadoGimnasio').textContent = 'Disponible';
                    document.getElementById('estadoGimnasio').className = 'text-2xl font-bold text-green-700';
                }

                // Actualizar espacios disponibles
                const espaciosDisponibles = Math.max(0, capacidadMaxima - personasActuales);
                document.getElementById('espaciosDisponibles').textContent = espaciosDisponibles;

                // Actualizar últimos registros
                actualizarUltimosRegistros(registrosRecientes);

                // Actualizar gráfico
                actualizarGrafico(datosGrafico);

                // Ocultar mensajes de error si existen
                const mensajeError = document.getElementById('mensajeError');
                if (mensajeError) {
                    mensajeError.classList.add('hidden');
                }

            } catch (error) {
                console.error('Error al actualizar la vista:', error);
                mostrarMensaje('Error al mostrar los datos. Intente recargar la página.', 'error');
            }
        }

        // Función para actualizar la hora de la última actualización
        function actualizarUltimaActualizacion() {
            const ahora = new Date();
            const opciones = {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            document.getElementById('lastUpdated').textContent = 'Actualizado: ' + ahora.toLocaleString('es-ES', opciones);
        }

        // Función para actualizar la tabla de últimos registros
        function actualizarUltimosRegistros(registros) {
            try {
                const tbody = document.getElementById('ultimosRegistros');
                if (!tbody) {
                    console.error('No se encontró el elemento tbody para los registros');
                    return;
                }

                // Limpiar la tabla
                tbody.innerHTML = '';

                // Verificar si hay registros
                if (!registros || registros.length === 0) {
                    const fila = document.createElement('tr');
                    const celda = document.createElement('td');
                    celda.colSpan = 4;
                    celda.className = 'px-6 py-4 text-center text-sm text-gray-500';
                    celda.textContent = 'No hay registros recientes';
                    fila.appendChild(celda);
                    tbody.appendChild(fila);
                    return;
                }

                // Agregar cada registro a la tabla
                registros.forEach(registro => {
                    try {
                        const fila = document.createElement('tr');
                        fila.className = 'hover:bg-gray-50';

                        // Hora
                        const horaCell = document.createElement('td');
                        horaCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                        horaCell.textContent = registro.hora || '--:--';

                        // Tipo (Entrada/Salida)
                        const tipoCell = document.createElement('td');
                        tipoCell.className = 'px-6 py-4 whitespace-nowrap';
                        const tipoBadge = document.createElement('span');

                        // Determinar el tipo (Entrada/Salida) basado en los datos
                        const tipo = registro.tipo || 'Entrada';
                        tipoBadge.className = `px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            tipo === 'Dentro' || tipo === 'Entrada' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                        }`;
                        tipoBadge.textContent = tipo;
                        tipoCell.appendChild(tipoBadge);

                        // Información de la persona
                        const personaCell = document.createElement('td');
                        personaCell.className = 'px-6 py-4';

                        // Construir la URL de la imagen de perfil
                        const nombre = registro.nombre || 'Usuario';
                        const dni = registro.dni || '';
                        const fotoUrl = registro.foto ||
                            `https://ui-avatars.com/api/?name=${encodeURIComponent(nombre)}&background=random`;

                        personaCell.innerHTML = `
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <img class="h-10 w-10 rounded-full" src="${fotoUrl}" alt="${nombre}">
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${nombre}</div>
                                    <div class="text-sm text-gray-500">${dni}</div>
                                </div>
                            </div>
                        `;

                        // Estado (opcional)
                        const estadoCell = document.createElement('td');
                        estadoCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                        estadoCell.textContent = registro.estado || '';

                        // Agregar celdas a la fila
                        fila.appendChild(horaCell);
                        fila.appendChild(tipoCell);
                        fila.appendChild(personaCell);
                        fila.appendChild(estadoCell);

                        // Agregar fila a la tabla
                        tbody.appendChild(fila);

                    } catch (error) {
                        console.error('Error al procesar un registro:', error, registro);
                    }
                });

            } catch (error) {
                console.error('Error al actualizar los registros:', error);
                mostrarMensaje('Error al cargar los registros recientes', 'error');
            }
        }

        // Función para actualizar el gráfico de barras
        function actualizarGrafico(datosGrafico = {}) {
            try {
                const contenedor = document.getElementById('graficoBarras');
                if (!contenedor) {
                    console.error('No se encontró el contenedor del gráfico');
                    return;
                }

                // Limpiar el contenedor
                contenedor.innerHTML = '';

                // Obtener la hora actual
                const ahora = new Date();
                const horaActual = ahora.getHours();
                const minutoActual = ahora.getMinutes();

                // Si no hay datos, mostrar un mensaje
                if (Object.keys(datosGrafico).length === 0) {
                    const mensaje = document.createElement('div');
                    mensaje.className = 'col-span-13 text-center text-gray-500 py-4';
                    mensaje.textContent = 'No hay datos disponibles para el gráfico';
                    contenedor.appendChild(mensaje);
                    return;
                }

                // Convertir los datos a un array y ordenarlos por hora
                const datosArray = Object.entries(datosGrafico)
                    .map(([hora, valor]) => ({
                        hora: hora,
                        valor: valor
                    }))
                    .sort((a, b) => a.hora.localeCompare(b.hora));

                // Encontrar el valor máximo para escalar las barras
                const maxValor = Math.max(...Object.values(datosGrafico), 1);

                // Crear las barras
                datosArray.forEach((dato, index) => {
                    const hora = parseInt(dato.hora.split(':')[0]);
                    const esHoraActual = hora === horaActual;
                    const altura = (dato.valor / maxValor) * 100;

                    const barraContainer = document.createElement('div');
                    barraContainer.className = 'flex flex-col items-center flex-1';
                    barraContainer.style.height = '100%';

                    // Contenedor de la barra
                    const barra = document.createElement('div');
                    barra.className = `w-full rounded-t-sm transition-all duration-300 relative group ${
                        esHoraActual ? 'bg-blue-600' : 'bg-blue-200 hover:bg-blue-300'
                    }`;
                    barra.style.height = `${altura}%`;
                    barra.style.minHeight = '20px'; // Mínimo para que sea visible
                    barra.title = `${dato.hora}: ${dato.valor} persona${dato.valor !== 1 ? 's' : ''}`;

                    // Etiqueta con el valor (solo visible al pasar el ratón)
                    const etiqueta = document.createElement('div');
                    etiqueta.className = 'absolute -top-8 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10';
                    etiqueta.textContent = `${dato.valor} persona${dato.valor !== 1 ? 's' : ''}`;
                    barra.appendChild(etiqueta);

                    // Etiqueta de la hora
                    const etiquetaHora = document.createElement('div');
                    etiquetaHora.className = 'text-xs text-gray-500 mt-1';
                    etiquetaHora.textContent = `${dato.hora}`;

                    // Resaltar la hora actual
                    if (esHoraActual) {
                        const indicadorActual = document.createElement('div');
                        indicadorActual.className = 'text-xs font-medium text-blue-600';
                        indicadorActual.textContent = 'Ahora';
                        barraContainer.appendChild(indicadorActual);
                    }

                    barraContainer.appendChild(barra);
                    barraContainer.appendChild(etiquetaHora);
                    contenedor.appendChild(barraContainer);
                });

            } catch (error) {
                console.error('Error al actualizar el gráfico:', error);
                // Mostrar un mensaje de error en el contenedor
                const mensajeError = document.createElement('div');
                mensajeError.className = 'col-span-13 text-center text-red-500 py-4';
                mensajeError.textContent = 'Error al cargar el gráfico';
                contenedor.appendChild(mensajeError);
            }
        }



        // Función para mostrar mensajes
        function mostrarMensaje(mensaje, tipo = 'info') {
            const mensajeDiv = document.createElement('div');
            let clases = 'fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg min-w-80 ';
            
            if (tipo === 'error') {
                clases += 'bg-red-100 text-red-700 border border-red-300';
            } else if (tipo === 'success') {
                clases += 'bg-green-100 text-green-700 border border-green-300';
            } else {
                clases += 'bg-blue-100 text-blue-700 border border-blue-300';
            }
            
            mensajeDiv.className = clases;
            mensajeDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <div>${mensaje}</div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-lg">&times;</button>
                </div>
            `;
            document.body.appendChild(mensajeDiv);
            
            // Auto-eliminar después de 5 segundos
            setTimeout(() => mensajeDiv.remove(), 5000);
        }

        // Inicializar la vista
        document.addEventListener('DOMContentLoaded', () => {
            // Cargar datos iniciales
            actualizarCapacidad();

            // Actualizar automáticamente cada 30 segundos
            setInterval(actualizarCapacidad, 30000);

            // Configurar el botón de actualización manual
            const btnActualizar = document.getElementById('btnActualizar');
            if (btnActualizar) {
                btnActualizar.addEventListener('click', (e) => {
                    e.preventDefault();
                    actualizarCapacidad();
                });
            }
        });
    </script>
</body>
</html>
