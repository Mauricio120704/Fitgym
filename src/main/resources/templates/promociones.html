<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Promociones</title>
    <link rel="stylesheet" th:href="@{/Estilos/promociones.css}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" th:href="@{/Estilos/sidebar-common.css}">
    <link rel="stylesheet" th:href="@{/Estilos/custom-select.css}">
    <script>
        (function() {
            const expanded = localStorage.getItem('sidebarExpanded') === 'true';
            if (expanded) {
                document.documentElement.style.setProperty('--sidebar-width', '16rem');
            } else {
                document.documentElement.style.setProperty('--sidebar-width', '5rem');
            }
        })();
    </script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="flex min-h-screen w-full bg-gray-100">
        <!-- Sidebar Fragment -->
        <div th:replace="~{fragments/sidebar :: sidebar('promociones')}" class="flex-shrink-0"></div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="sticky top-0 z-50 border-b bg-white shadow-sm">
                <div class="flex items-center justify-between p-3">
                    <div class="flex items-center">
                        <button id="menu-button" class="p-1 rounded-md text-gray-500 hover:bg-gray-100 focus:outline-none">
                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="flex-1 overflow-auto p-4">
        <div class="header">
            <div class="header-content">
                <h1>Gesti√≥n de Promociones</h1>
                <p>Crea y administra descuentos en membres√≠as</p>
            </div>
            <div style="display:flex; align-items:center; gap:.5rem; margin-left:auto;">
            <form id="searchForm" th:action="@{/promociones}" method="get" style="display: flex; flex-wrap: nowrap; gap: 0.5rem; align-items: center; width: 100%; max-width: 800px;">
                <div style="position: relative; flex: 1; min-width: 200px;">
                    <svg style="position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#9ca3af; z-index: 10;" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" name="q" th:value="${q}" placeholder="Buscar promociones..." class="form-input" style="width: 100%; padding: 0.5rem 1rem 0.5rem 2.5rem; border-radius: 9999px; border: 1px solid #d1d5db; background-color: #fff; font-size: 0.875rem; line-height: 1.25rem; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;">
                </div>
                
                <!-- Selector de Estado -->
                <div style="position: relative; min-width: 180px; flex-shrink: 0;">
                    <select name="estado" class="form-select" onchange="this.form.submit()" style="width: 100%; padding: 0.5rem 2.5rem 0.5rem 1rem; border-radius: 9999px; border: 1px solid #d1d5db; background-color: #fff; font-size: 0.875rem; line-height: 1.25rem; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2220%22%20height%3D%2220%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22%236b7280%22%3E%3Cpath%20d%3D%22M7%2010l5%205%205-5z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 12px center; background-size: 16px 12px; cursor: pointer;">
                        <option value="" th:selected="${estadoFiltro == null or estadoFiltro == ''}">Todos los estados</option>
                        <option th:each="estado : ${todosEstados}" 
                                th:value="${estado.name()}"
                                th:text="${estado.name() == 'ACTIVE' ? 'Activa' : (estado.name() == 'INACTIVE' ? 'Inactiva' : 'Expirada')}"
                                th:selected="${estadoFiltro != null && estadoFiltro == estado.name()}">
                        </option>
                    </select>
                </div>
                
                <button type="submit" class="btn" style="background:#f97316; color:#fff; border-radius: 9999px; padding: 0.5rem 1.25rem; border: none; font-weight: 500; font-size: 0.875rem; line-height: 1.25rem; display: inline-flex; align-items: center; justify-content: center; white-space: nowrap; cursor: pointer; transition: background-color 0.2s ease-in-out; flex-shrink: 0; height: 38px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                        <line x1="21" y1="10" x2="3" y2="10"></line>
                        <line x1="21" y1="6" x2="3" y2="6"></line>
                        <line x1="21" y1="14" x2="3" y2="14"></line>
                        <line x1="21" y1="18" x2="3" y2="18"></line>
                    </svg>
                    Filtrar
                </button>
            </form>
            <a th:href="@{/promociones/historial}" class="btn btn-secondary" style="white-space:nowrap;">Historial</a>
            </div>
        </div>

        <section>
            <h2 class="section-title">Promociones Activas</h2>
            <div class="promo-grid">
                <div th:each="p : ${activas}" class="promo-card" th:attr="id=${'promo-' + p.id}">
                    <div class="promo-header">
                        <div class="promo-title-wrapper" th:with="now=${hoy}">
                            <h3 class="promo-title" th:text="${p.nombre}">Nombre</h3>
                            <span class="badge"
                                  th:classappend="
                                    ${now.isBefore(p.fechaInicio)} ? ' badge-pending' :
                                    (${now.isAfter(p.fechaFin)} ? ' badge-completed' :
                                      (${p.estado.name() == 'ACTIVE'} ? ' badge-active' : ' badge-inactive'))
                                  "
                                  th:text="
                                    ${now.isBefore(p.fechaInicio)} ? 'Pendiente' :
                                    (${now.isAfter(p.fechaFin)} ? 'Concluida' :
                                      (${p.estado.name() == 'ACTIVE'} ? 'Activa' : 'Inactiva'))
                                  ">Estado</span>
                            <span class="chip-expired" th:if="${now.isAfter(p.fechaFin)}">Expirada</span>
                        </div>
                    </div>
                    <p class="promo-description" th:text="${p.descripcion}">Descripci√≥n</p>
                    <div class="promo-value">
                        <div class="value-icon" th:text="${p.tipo.name() == 'PERCENTAGE' ? '%' : 'S/'}">%</div>
                        <div class="value-amount" th:text="${p.tipo.name() == 'PERCENTAGE' ? '%' + p.valor : 'S/ ' + p.valor}">$20</div>
                        <div class="value-label" th:text="${p.tipo.name() == 'PERCENTAGE' ? 'DESCUENTO' : 'AHORRO'}">DESCUENTO</div>
                    </div>
                    <div class="promo-details">
                        <div class="detail-row">
                            <span>üìÖ</span>
                            <div>
                                <div class="detail-label">Per√≠odo de vigencia</div>
                                <div class="detail-value" th:text="${#temporals.format(p.fechaInicio, 'dd MMM yyyy') + ' - ' + #temporals.format(p.fechaFin, 'dd MMM yyyy')}">01 Ene - 31 Ene</div>
                            </div>
                        </div>
                        <div class="detail-row">
                            <span>üë•</span>
                            <div>
                                <div class="detail-label">Membres√≠as aplicables</div>
                                <div class="membership-tags">
                                    <span class="membership-tag" th:each="m : ${p.membresias}" th:text="${m.membresia}">Mensual</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="usage-section">
                        <div class="usage-header">
                            <span class="detail-label">Usos de la promoci√≥n</span>
                            <span class="usage-count" th:text="${p.usados + ' / ' + p.maxUsos}">0 / 100</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" th:style="${'width:' + ((p.usados * 100) / p.maxUsos) + '%'}"></div>
                        </div>
                        <div class="usage-subtitle" th:text="(${p.maxUsos} - ${p.usados}) + ' usos disponibles'">0 usos disponibles</div>
                    </div>
                    <div class="promo-actions">
                        <button class="btn-action" type="button"
                                th:attr="
                                  data-id=${p.id},
                                  data-nombre=${p.nombre},
                                  data-tipo=${p.tipo.name()},
                                  data-descripcion=${p.descripcion},
                                  data-valor=${p.valor},
                                  data-maxusos=${p.maxUsos},
                                  data-inicio=${#temporals.format(p.fechaInicio, 'yyyy-MM-dd')},
                                  data-fin=${#temporals.format(p.fechaFin, 'yyyy-MM-dd')},
                                  data-tipopromocion=${p.tipoPromocion},
                                  data-tipoplan=${p.tipoPlan},
                                  data-claseid=${p.clase == null ? '' : p.clase.id}
                                "
                                onclick="openEditFromButton(this)"><span class="emoji">‚úèÔ∏è</span><span>Editar</span></button>
                        <form th:action="@{'/promociones/' + ${p.id} + '/toggle'}" method="post">
                            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <button class="btn-action" type="submit">
                                <span class="emoji" th:text="${p.estado.name() == 'ACTIVE' ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}"></span>
                                <span th:text="${p.estado.name() == 'ACTIVE' ? 'Desactivar' : 'Activar'}"></span>
                            </button>
                        </form>
                        <form th:action="@{'/promociones/' + ${p.id} + '/delete'}" method="post" onsubmit="return confirm('¬øEliminar esta promoci√≥n?');">
                            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <button class="btn-action delete" type="submit"><span class="emoji">üóëÔ∏è</span><span>Eliminar</span></button>
                        </form>
                    </div>
                </div>
            </div>
        </section>
        <section>
            <h2 class="section-title">Promociones Expiradas</h2>
            <div class="promo-grid">
                <div th:each="p : ${expiradas}" class="promo-card" th:attr="id=${'promo-' + p.id}">
                    <div class="promo-header">
                        <div class="promo-title-wrapper" th:with="now=${hoy}">
                            <h3 class="promo-title" th:text="${p.nombre}">Nombre</h3>
                            <span class="badge badge-completed">Concluida</span>
                            <span class="chip-expired">Expirada</span>
                        </div>
                    </div>
                    <p class="promo-description" th:text="${p.descripcion}">Descripci√≥n</p>
                    <div class="promo-value">
                        <div class="value-icon" th:text="${p.tipo.name() == 'PERCENTAGE' ? '%' : 'S/'}">%</div>
                        <div class="value-amount" th:text="${p.tipo.name() == 'PERCENTAGE' ? '%' + p.valor : 'S/ ' + p.valor}">$20</div>
                        <div class="value-label" th:text="${p.tipo.name() == 'PERCENTAGE' ? 'DESCUENTO' : 'AHORRO'}">DESCUENTO</div>
                    </div>
                    <div class="promo-actions">
                        <button class="btn-action" type="button"
                                th:attr="
                                  data-id=${p.id},
                                  data-nombre=${p.nombre},
                                  data-tipo=${p.tipo.name()},
                                  data-descripcion=${p.descripcion},
                                  data-valor=${p.valor},
                                  data-maxusos=${p.maxUsos},
                                  data-inicio=${#temporals.format(p.fechaInicio, 'yyyy-MM-dd')},
                                  data-fin=${#temporals.format(p.fechaFin, 'yyyy-MM-dd')}
                                "
                                onclick="openEditFromButton(this)"><span class="emoji">‚úèÔ∏è</span><span>Editar</span></button>
                        <button class="btn-action" type="button"
                                th:attr="
                                  data-id=${p.id},
                                  data-nombre=${p.nombre},
                                  data-tipo=${p.tipo.name()},
                                  data-descripcion=${p.descripcion},
                                  data-valor=${p.valor},
                                  data-maxusos=${p.maxUsos},
                                  data-inicio=${#temporals.format(hoy, 'yyyy-MM-dd')},
                                  data-fin=${#temporals.format(hoy.plusDays(30), 'yyyy-MM-dd')},
                                  data-tipopromocion=${p.tipoPromocion},
                                  data-tipoplan=${p.tipoPlan},
                                  data-claseid=${p.clase == null ? '' : p.clase.id}
                                "
                                onclick="openReactivateFromButton(this)"><span class="emoji">‚ñ∂Ô∏è</span><span>Reactivar</span></button>
                        <form th:action="@{'/promociones/' + ${p.id} + '/delete'}" method="post" onsubmit="return confirm('¬øEliminar esta promoci√≥n?');">
                            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <button class="btn-action delete" type="submit"><span class="emoji">üóëÔ∏è</span><span>Eliminar</span></button>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <section>
            <h2 class="section-title">Promociones Inactivas</h2>
            <div class="promo-grid">
                <div th:each="p : ${inactivas}" class="promo-card" th:attr="id=${'promo-' + p.id}">
                    <div class="promo-header">
                        <div class="promo-title-wrapper" th:with="now=${hoy}">
                            <h3 class="promo-title" th:text="${p.nombre}">Nombre</h3>
                            <span class="badge"
                                  th:classappend="
                                    ${now.isBefore(p.fechaInicio)} ? ' badge-pending' :
                                    (${now.isAfter(p.fechaFin)} ? ' badge-completed' : ' badge-inactive')
                                  "
                                  th:text="
                                    ${now.isBefore(p.fechaInicio)} ? 'Pendiente' :
                                    (${now.isAfter(p.fechaFin)} ? 'Concluida' : 'Inactiva')
                                  ">Estado</span>
                            <span class="chip-expired" th:if="${now.isAfter(p.fechaFin)}">Expirada</span>
                        </div>
                    </div>
                    <p class="promo-description" th:text="${p.descripcion}">Descripci√≥n</p>
                    <div class="promo-value">
                        <div class="value-icon" th:text="${p.tipo.name() == 'PERCENTAGE' ? '%' : 'S/'}">%</div>
                        <div class="value-amount" th:text="${p.tipo.name() == 'PERCENTAGE' ? '%' + p.valor : 'S/ ' + p.valor}">$20</div>
                        <div class="value-label" th:text="${p.tipo.name() == 'PERCENTAGE' ? 'DESCUENTO' : 'AHORRO'}">DESCUENTO</div>
                    </div>
                    <div class="promo-actions">
                        <button class="btn-action" type="button"
                                th:attr="
                                  data-id=${p.id},
                                  data-nombre=${p.nombre},
                                  data-tipo=${p.tipo.name()},
                                  data-descripcion=${p.descripcion},
                                  data-valor=${p.valor},
                                  data-maxusos=${p.maxUsos},
                                  data-inicio=${#temporals.format(p.fechaInicio, 'yyyy-MM-dd')},
                                  data-fin=${#temporals.format(p.fechaFin, 'yyyy-MM-dd')}
                                "
                                onclick="openEditFromButton(this)"><span class="emoji">‚úèÔ∏è</span><span>Editar</span></button>
                        <form th:action="@{'/promociones/' + ${p.id} + '/toggle'}" method="post">
                            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <button class="btn-action" type="submit"><span class="emoji">‚ñ∂Ô∏è</span><span>Activar</span></button>
                        </form>
                        <form th:action="@{'/promociones/' + ${p.id} + '/delete'}" method="post" onsubmit="return confirm('¬øEliminar esta promoci√≥n?');">
                            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <button class="btn-action delete" type="submit"><span class="emoji">üóëÔ∏è</span><span>Eliminar</span></button>
                        </form>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <button class="fab" onclick="openModalCreate()">Ôºã</button>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Nueva Promoci√≥n</h2>
                <button class="btn-close" onclick="closeModal()">&times;</button>
            </div>
            <form class="modal-body" id="promoForm" th:action="@{/promociones}" method="post">
                <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Nombre de la Promoci√≥n <span class="required">*</span></label>
                        <input type="text" class="form-input" name="nombre" id="promoName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tipo de Descuento <span class="required">*</span></label>
                        <select class="form-select" name="tipo" id="discountType" required onchange="updateDiscountPrefix()">
                            <option value="">Seleccionar</option>
                            <option value="PERCENTAGE">Porcentaje (%)</option>
                            <option value="AMOUNT">Monto Fijo ($)</option>
                        </select>
                    </div>
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Descripci√≥n</label>
                    <textarea class="form-textarea" name="descripcion" id="description" placeholder="Descripci√≥n de la promoci√≥n"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Valor del Descuento <span class="required">*</span></label>
                        <div style="position:relative;">
                            <span id="discountPrefix" style="position:absolute;left:.875rem;top:50%;transform:translateY(-50%);color:#6b7280;">%</span>
                            <input type="number" step="0.01" class="form-input" style="padding-left:2rem;" name="valor" id="discountValue" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">N√∫mero M√°ximo de Usos <span class="required">*</span></label>
                        <input type="number" class="form-input" name="maxUsos" id="maxUses" min="1" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Fecha de Inicio <span class="required">*</span></label>
                        <input type="date" class="form-input" name="fechaInicio" id="startDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fecha de Fin <span class="required">*</span></label>
                        <input type="date" class="form-input" name="fechaFin" id="endDate" required>
                    </div>
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Aplicar a <span class="required">*</span></label>
                    <select class="form-select" name="tipoPromocion" id="promoType" required onchange="updatePromoTypeSections()">
                        <option value="MEMBRESIA" selected>Plan de membres√≠a</option>
                        <option value="CLASE">Clase individual</option>
                    </select>
                </div>
                <div class="form-group full-width" id="membresiasSection">
                    <label class="form-label">Membres√≠as Aplicables <span class="required">*</span></label>
                    <div class="checkbox-group">
                        <label class="checkbox-label"><input type="checkbox" class="form-checkbox" name="membership" value="Mensual"> <span>Mensual</span></label>
                        <label class="checkbox-label"><input type="checkbox" class="form-checkbox" name="membership" value="Anual"> <span>Anual</span></label>
                    </div>
                </div>
                <div class="form-group full-width" id="tipoPlanSection">
                    <label class="form-label">Tipo de plan (opcional)</label>
                    <select class="form-select" name="tipoPlan" id="tipoPlan">
                        <option value="">Todos los tipos</option>
                        <option value="B√°sico">B√°sico</option>
                        <option value="Premium">Premium</option>
                        <option value="Elite">Elite</option>
                    </select>
                </div>
                <div class="form-group full-width" id="claseSection" style="display:none;">
                    <label class="form-label">Clase aplicable</label>
                    <!-- Este select se mantiene nativo (sin custom-select) para poder cargar opciones por AJAX -->
                    <select class="form-select no-custom-select" name="claseId" id="claseId">
                        <option value="">-- Selecciona una clase --</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                    <button type="submit" id="modalSubmitButton" class="btn btn-primary">Crear Promoci√≥n</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function openModal(){ document.getElementById('modalOverlay').style.display='flex'; }
        function closeModal(){ document.getElementById('modalOverlay').style.display='none'; }
        async function cargarClasesPorRango() {
            const inicio = document.getElementById('startDate')?.value;
            const fin = document.getElementById('endDate')?.value;
            const select = document.getElementById('claseId');
            if (!select) return;

            select.innerHTML = '<option value="">-- Selecciona una clase --</option>';

            if (!inicio || !fin) {
                return;
            }

            try {
                const params = new URLSearchParams({ inicio, fin });
                const resp = await fetch('/promociones/clases-disponibles?' + params.toString());
                if (!resp.ok) return;
                const data = await resp.json();
                (data || []).forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.label;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error('Error cargando clases para promociones', e);
            }
        }

        async function updatePromoTypeSections(){
            const promoType = document.getElementById('promoType').value;
            const membresiasSection = document.getElementById('membresiasSection');
            const tipoPlanSection = document.getElementById('tipoPlanSection');
            const claseSection = document.getElementById('claseSection');

            if (promoType === 'CLASE') {
                if (membresiasSection) membresiasSection.style.display = 'none';
                if (tipoPlanSection) tipoPlanSection.style.display = 'none';
                if (claseSection) claseSection.style.display = 'block';
                // Cargar clases si hay fechas definidas
                const inicio = document.getElementById('startDate')?.value;
                const fin = document.getElementById('endDate')?.value;
                if (inicio && fin) {
                    await cargarClasesPorRango();
                }
            } else {
                if (membresiasSection) membresiasSection.style.display = 'block';
                if (tipoPlanSection) tipoPlanSection.style.display = 'block';
                if (claseSection) claseSection.style.display = 'none';
            }
        }
        function openModalCreate(){
            const form = document.getElementById('promoForm');
            form.setAttribute('action', '/promociones');
            document.getElementById('modalTitle').textContent = 'Nueva Promoci√≥n';
            form.reset();
            // valores por defecto
            const promoType = document.getElementById('promoType');
            if (promoType) promoType.value = 'MEMBRESIA';
            const tipoPlan = document.getElementById('tipoPlan');
            if (tipoPlan) tipoPlan.value = '';
            const claseSelect = document.getElementById('claseId');
            if (claseSelect) claseSelect.value = '';
            updateDiscountPrefix();
            updatePromoTypeSections();
            const submitBtn = document.getElementById('modalSubmitButton');
            if (submitBtn) submitBtn.textContent = 'Crear Promoci√≥n';
            openModal();
        }
        function updateDiscountPrefix(){
            const type = document.getElementById('discountType').value;
            const prefix = document.getElementById('discountPrefix');
            if(type === 'PERCENTAGE'){ prefix.textContent = '%'; }
            else if(type === 'AMOUNT'){ prefix.textContent = 'S/'; }
        }
        function openEditFromButton(btn){
            const form = document.getElementById('promoForm');
            const id = btn.dataset.id;
            form.setAttribute('action', '/promociones/' + id + '/editar');
            document.getElementById('modalTitle').textContent = 'Editar Promoci√≥n';
            document.getElementById('promoName').value = btn.dataset.nombre;
            document.getElementById('discountType').value = btn.dataset.tipo;
            document.getElementById('description').value = btn.dataset.descripcion || '';
            document.getElementById('discountValue').value = btn.dataset.valor;
            document.getElementById('maxUses').value = btn.dataset.maxusos;
            document.getElementById('startDate').value = btn.dataset.inicio;
            document.getElementById('endDate').value = btn.dataset.fin;

            const promoType = document.getElementById('promoType');
            const tipoPlan = document.getElementById('tipoPlan');
            const claseSelect = document.getElementById('claseId');
            if (promoType && btn.dataset.tipopromocion) {
                promoType.value = btn.dataset.tipopromocion;
            }
            if (tipoPlan) {
                tipoPlan.value = btn.dataset.tipoplan || '';
            }

            updateDiscountPrefix();
            updatePromoTypeSections().then(() => {
                if (claseSelect && btn.dataset.claseid) {
                    claseSelect.value = btn.dataset.claseid;
                }
            });
            const submitBtn = document.getElementById('modalSubmitButton');
            if (submitBtn) submitBtn.textContent = 'Guardar cambios';
            openModal();
        }

        function openReactivateFromButton(btn){
            const form = document.getElementById('promoForm');
            const id = btn.dataset.id;
            form.setAttribute('action', '/promociones/' + id + '/reactivar');
            document.getElementById('modalTitle').textContent = 'Reactivar Promoci√≥n';
            document.getElementById('promoName').value = btn.dataset.nombre;
            document.getElementById('discountType').value = btn.dataset.tipo;
            document.getElementById('description').value = btn.dataset.descripcion || '';
            document.getElementById('discountValue').value = btn.dataset.valor;
            document.getElementById('maxUses').value = btn.dataset.maxusos;
            document.getElementById('startDate').value = btn.dataset.inicio;
            document.getElementById('endDate').value = btn.dataset.fin;

            const promoType = document.getElementById('promoType');
            const tipoPlan = document.getElementById('tipoPlan');
            const claseSelect = document.getElementById('claseId');
            if (promoType && btn.dataset.tipopromocion) {
                promoType.value = btn.dataset.tipopromocion;
            }
            if (tipoPlan) {
                tipoPlan.value = btn.dataset.tipoplan || '';
            }

            updateDiscountPrefix();
            updatePromoTypeSections().then(() => {
                if (claseSelect && btn.dataset.claseid) {
                    claseSelect.value = btn.dataset.claseid;
                }
            });
            const submitBtn = document.getElementById('modalSubmitButton');
            if (submitBtn) submitBtn.textContent = 'Reactivar';
            openModal();
        }

        document.addEventListener('DOMContentLoaded', function() {
            const startInput = document.getElementById('startDate');
            const endInput = document.getElementById('endDate');
            if (startInput) startInput.addEventListener('change', () => {
                if (document.getElementById('promoType').value === 'CLASE') {
                    cargarClasesPorRango();
                }
            });
            if (endInput) endInput.addEventListener('change', () => {
                if (document.getElementById('promoType').value === 'CLASE') {
                    cargarClasesPorRango();
                }
            });
        });
    </script>
            </main>
        </div>
    </div>
    <!-- Cargar el script del sidebar -->
    <script th:src="@{/sidebar.js}"></script>
    <!-- Versionado simple para forzar recarga del custom-select actualizado -->
    <script th:src="@{/custom-select.js?v=2}"></script>
    <!-- Inicializar el sidebar despu√©s de cargar el DOM -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Asegurarse de que el bot√≥n del men√∫ est√© configurado correctamente
            const menuButton = document.getElementById('menu-button');
            if (menuButton) {
                menuButton.addEventListener('click', function() {
                    document.documentElement.classList.toggle('sidebar-expanded');
                    localStorage.setItem('sidebarExpanded', document.documentElement.classList.contains('sidebar-expanded'));
                });
            }
        });
    </script>
</body>
</html>
