<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Promociones</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { 
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif; 
            background:#f8f9fa; 
            color:#212529; 
            overflow-x: hidden;
        }
        .container { 
            width: 100%; 
            margin: 0; 
            padding: 0 1rem; 
            max-width: 100%;
        }
        .header { display:flex; justify-content:space-between; align-items:center; margin: 0 0 1.5rem 0; padding: 1rem 0; border-bottom: 1px solid #e5e7eb; }
        .header-content h1 { font-size:1.75rem; font-weight:700; margin-bottom:.25rem; color:#000; }
        .header-content p { color:#6c757d; font-size:.95rem; }
        .section-title { font-size:1.25rem; font-weight:600; margin-bottom:1.5rem; color:#000; }
        .promo-grid { 
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .promo-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
        .promo-card { 
            background: #ffffff;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            display: flex;
            flex-direction: column;
            height: 100%;
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
            position: relative;
            overflow: hidden;
        }
        
        .promo-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Sidebar styles eliminados aqu√≠ para evitar conflictos. El fragmento y sidebar.js controlan el aside. */
        
        /* Sidebar styles */
        :root {
            --sidebar-width: 5rem;
        }
        
        @media (min-width: 768px) {
            :root {
                --sidebar-width: 16rem;
            }
        }
        
        .main-content {
            margin-left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
            transition: all 0.3s ease;
        }
        
        /* Ajustes de contenedor ya definidos arriba. Se evita duplicidad. */
        
        @media (max-width: 1024px) {
            .main-content {
                margin-left: 0;
                width: 100%;
            }
        }
        .badge { 
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .badge-active{ background:#10b981; color:#fff; }
        .badge.active { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .badge.expired { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .badge.inactive { background: #f3f4f6; color: #4b5563; border: 1px solid #e5e7eb; }
        .promo-header { 
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #f3f4f6;
        }
        .promo-title-wrapper{ display:flex; align-items:center; gap:.75rem; }
        .promo-title{ font-size:1.15rem; font-weight:600; color:#000; }
        .badge-pending{ background:#fef3c7; color:#b45309; }
        .badge-completed{ background:#e0e7ff; color:#3730a3; }
        .chip-expired{ background:#fee2e2; color:#b91c1c; padding:.2rem .5rem; border-radius:999px; font-size:.7rem; font-weight:700; margin-left:.5rem; }
        .promo-description{ color:#6c757d; font-size:.9rem; margin-bottom:1.5rem; }
        .promo-description{ display:-webkit-box; -webkit-line-clamp:3; line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; min-height:3.6em; }
        .promo-value{ background:linear-gradient(135deg,#f0f4ff 0%,#e0e7ff 100%); border-radius:10px; padding:2rem; text-align:center; margin-bottom:1.5rem; min-height:140px; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        .value-icon{ color:#93a3ff; font-size:2rem; margin-bottom:.5rem; }
        .value-amount{ font-size:2.75rem; font-weight:700; color:#f97316; margin-bottom:.25rem; }
        .value-label{ color:#6b7280; font-size:.8rem; font-weight:500; text-transform:uppercase; letter-spacing:.5px; }
        .promo-details{ display:flex; flex-direction:column; gap:1rem; margin-bottom:1.5rem; }
        .detail-row{ display:flex; align-items:center; gap:.75rem; color:#4b5563; font-size:.9rem; }
        .detail-row span { font-size: 1.2rem; color: #f97316; }
        .detail-label{ color:#6b7280; font-weight:500; margin-bottom:.25rem; }
        .detail-value{ color:#000; font-weight:500; }
        .membership-tags{ display:flex; gap:.5rem; margin-top:.5rem; flex-wrap:wrap; }
        .membership-tag{ background:#f3f4f6; padding:.35rem .75rem; border-radius:6px; font-size:.85rem; color:#4b5563; }
        .usage-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem; }
        .usage-count{ font-size:.85rem; font-weight:600; color:#000; }
        .progress-bar{ height:8px; background:#e5e7eb; border-radius:10px; overflow:hidden; margin-bottom:.5rem; }
        .progress-fill{ height:100%; background:linear-gradient(90deg,#f97316 0%, #fb923c 100%); border-radius:10px; transition:width .3s ease; }
        .promo-actions{ display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:.75rem; margin-top:auto; align-items:stretch; }
        .promo-actions > *{ width:100%; min-width:0; }
        .promo-actions form{ width:100%; display:contents; }
        .btn-action { 
            flex: 1;
            padding: 0.65rem 1rem;
            border: 1px solid #f97316;
            background: #fff;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            font-size: 0.9rem;
            font-weight: 500;
            color: #f97316;
            transition: all 0.2s ease;
            min-height: 44px;
        }
        
        .btn-action:hover {
            background: #fff7ed;
            transform: translateY(-1px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .btn-action:active {
            transform: translateY(0);
        }
        
        .btn-action .emoji { 
            font-size: 1.3rem; 
            line-height: 1; 
        }
        
        .btn-action span { 
            white-space: nowrap; 
        }
        
        .btn-action.edit { 
            background: #fff; 
            color: #f97316; 
            border-color: #f97316; 
        }
        
        .btn-action.edit:hover { 
            background: #fff7ed; 
            border-color: #ea580c;
        }
        
        .btn-action.delete { 
            background: #fff; 
            color: #dc2626; 
            border-color: #dc2626; 
        }
        
        .btn-action.delete:hover { 
            background: #fef2f2; 
            border-color: #b91c1c;
        }
        .fab{ position:fixed; right:24px; bottom:24px; background:#f97316; color:#fff; border:none; width:56px; height:56px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:28px; cursor:pointer; box-shadow:0 10px 15px -3px rgba(0,0,0,.1); z-index:1100; }
        .fab:hover{ background:#ea580c; }
        /* Modal */
        .modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; padding:1rem; z-index:1000; }
        .modal{ background:#fff; border-radius:12px; width:100%; max-width:600px; max-height:90vh; overflow-y:auto; box-shadow:0 20px 25px -5px rgba(0,0,0,.1), 0 10px 10px -5px rgba(0,0,0,.04); }
        .modal-header{ padding:1.5rem; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center; }
        .modal-title{ font-size:1.25rem; font-weight:600; color:#111827; }
        .btn-close{ background:none; border:none; font-size:1.5rem; color:#9ca3af; cursor:pointer; width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:6px; }
        .btn-close:hover{ background:#f3f4f6; color:#4b5563; }
        .modal-body{ padding:1.5rem; }
        .modal-footer{ padding:1.5rem; border-top:1px solid #e5e7eb; display:flex; justify-content:flex-end; gap:.75rem; }
        .form-row{ display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:1.25rem; }
        .form-group{ margin-bottom:1.25rem; }
        .form-group.full-width{ grid-column:1 / -1; }
        .form-label{ display:block; font-size:.875rem; font-weight:500; color:#374151; margin-bottom:.5rem; }
        .required{ color:#ef4444; }
        .form-input,.form-select,.form-textarea{ width:100%; padding:.625rem .875rem; border:1px solid #d1d5db; border-radius:8px; font-size:.9rem; color:#111827; }
        .form-textarea{ resize:vertical; min-height:80px; }
        .checkbox-group{ display:flex; flex-direction:column; gap:.75rem; }
        .checkbox-label{ display:flex; align-items:center; gap:.75rem; cursor:pointer; padding:.75rem; border-radius:8px; }
        .form-checkbox{ width:18px; height:18px; border:2px solid #d1d5db; border-radius:4px; accent-color:#f97316; }
        .btn{ padding:.625rem 1.25rem; border-radius:10px; font-size:.9rem; font-weight:600; cursor:pointer; border:none; }
        .btn-secondary { 
            background: #fff; 
            color: #f97316; 
            border: 1px solid #f97316;
            transition: all 0.2s ease;
        }
        
        .btn-secondary:hover { 
            background: #fff7ed; 
            border-color: #ea580c;
        }
        
        .btn-primary { 
            background: #f97316; 
            color: #fff; 
            border: 1px solid #f97316;
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover { 
            background: #ea580c; 
            border-color: #ea580c;
        }
        /* Se usa auto-fill con minmax en .promo-grid; no forzar 1 columna en 1400px para mantener responsividad natural */
        @media (max-width:768px){ .container{ padding:1rem; } .form-row{ grid-template-columns:1fr; } }
        .reactivate-section{ display:flex; gap:.5rem; align-items:center; margin:.5rem 0 1rem; }
        .reactivate-section .form-input{ padding:.4rem .6rem; height:36px; }
    </style>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" th:href="@{/Estilos/sidebar-common.css}">
    <script>
        (function() {
            const expanded = localStorage.getItem('sidebarExpanded') === 'true';
            if (expanded) {
                document.documentElement.style.setProperty('--sidebar-width', '16rem');
            } else {
                document.documentElement.style.setProperty('--sidebar-width', '5rem');
            }
        })();
    </script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="flex min-h-screen w-full bg-gray-100">
        <!-- Sidebar Fragment -->
        <div th:replace="~{fragments/sidebar :: sidebar('promociones')}" class="flex-shrink-0"></div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="sticky top-0 z-50 border-b bg-white shadow-sm">
                <div class="flex items-center justify-between p-3">
                    <div class="flex items-center">
                        <button id="menu-button" class="p-1 rounded-md text-gray-500 hover:bg-gray-100 focus:outline-none">
                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="flex-1 overflow-auto p-4">
        <div class="header">
            <div class="header-content">
                <h1>Gesti√≥n de Promociones</h1>
                <p>Crea y administra descuentos en membres√≠as</p>
            </div>
            <div style="display:flex; align-items:center; gap:.5rem; margin-left:auto;">
            <form id="searchForm" th:action="@{/promociones}" method="get" style="display: flex; flex-wrap: nowrap; gap: 0.5rem; align-items: center; width: 100%; max-width: 800px;">
                <div style="position: relative; flex: 1; min-width: 200px;">
                    <svg style="position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#9ca3af; z-index: 10;" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" name="q" th:value="${q}" placeholder="Buscar promociones..." class="form-input" style="width: 100%; padding: 0.5rem 1rem 0.5rem 2.5rem; border-radius: 9999px; border: 1px solid #d1d5db; background-color: #fff; font-size: 0.875rem; line-height: 1.25rem; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;">
                </div>
                
                <!-- Selector de Estado -->
                <div style="position: relative; min-width: 180px; flex-shrink: 0;">
                    <select name="estado" class="form-select" onchange="this.form.submit()" style="width: 100%; padding: 0.5rem 2.5rem 0.5rem 1rem; border-radius: 9999px; border: 1px solid #d1d5db; background-color: #fff; font-size: 0.875rem; line-height: 1.25rem; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2220%22%20height%3D%2220%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22%236b7280%22%3E%3Cpath%20d%3D%22M7%2010l5%205%205-5z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 12px center; background-size: 16px 12px; cursor: pointer;">
                        <option value="" th:selected="${estadoFiltro == null or estadoFiltro == ''}">Todos los estados</option>
                        <option th:each="estado : ${todosEstados}" 
                                th:value="${estado.name()}"
                                th:text="${estado.name() == 'ACTIVE' ? 'Activa' : (estado.name() == 'INACTIVE' ? 'Inactiva' : 'Expirada')}"
                                th:selected="${estadoFiltro != null && estadoFiltro == estado.name()}">
                        </option>
                    </select>
                </div>
                
                <button type="submit" class="btn" style="background:#f97316; color:#fff; border-radius: 9999px; padding: 0.5rem 1.25rem; border: none; font-weight: 500; font-size: 0.875rem; line-height: 1.25rem; display: inline-flex; align-items: center; justify-content: center; white-space: nowrap; cursor: pointer; transition: background-color 0.2s ease-in-out; flex-shrink: 0; height: 38px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                        <line x1="21" y1="10" x2="3" y2="10"></line>
                        <line x1="21" y1="6" x2="3" y2="6"></line>
                        <line x1="21" y1="14" x2="3" y2="14"></line>
                        <line x1="21" y1="18" x2="3" y2="18"></line>
                    </svg>
                    Filtrar
                </button>
            </form>
            <a th:href="@{/promociones/historial}" class="btn btn-secondary" style="white-space:nowrap;">Historial</a>
            </div>
        </div>

        <section>
            <h2 class="section-title">Promociones Activas</h2>
            <div class="promo-grid">
                <div th:each="p : ${activas}" class="promo-card" th:attr="id=${'promo-' + p.id}">
                    <div class="promo-header">
                        <div class="promo-title-wrapper" th:with="now=${hoy}">
                            <h3 class="promo-title" th:text="${p.nombre}">Nombre</h3>
                            <span class="badge"
                                  th:classappend="
                                    ${now.isBefore(p.fechaInicio)} ? ' badge-pending' :
                                    (${now.isAfter(p.fechaFin)} ? ' badge-completed' :
                                      (${p.estado.name() == 'ACTIVE'} ? ' badge-active' : ' badge-inactive'))
                                  "
                                  th:text="
                                    ${now.isBefore(p.fechaInicio)} ? 'Pendiente' :
                                    (${now.isAfter(p.fechaFin)} ? 'Concluida' :
                                      (${p.estado.name() == 'ACTIVE'} ? 'Activa' : 'Inactiva'))
                                  ">Estado</span>
                            <span class="chip-expired" th:if="${now.isAfter(p.fechaFin)}">Expirada</span>
                        </div>
                    </div>
                    <p class="promo-description" th:text="${p.descripcion}">Descripci√≥n</p>
                    <div class="promo-value">
                        <div class="value-icon" th:text="${p.tipo.name() == 'PERCENTAGE' ? '%' : 'S/'}">%</div>
                        <div class="value-amount" th:text="${p.tipo.name() == 'PERCENTAGE' ? '%' + p.valor : 'S/ ' + p.valor}">$20</div>
                        <div class="value-label" th:text="${p.tipo.name() == 'PERCENTAGE' ? 'DESCUENTO' : 'AHORRO'}">DESCUENTO</div>
                    </div>
                    <div class="promo-details">
                        <div class="detail-row">
                            <span>üìÖ</span>
                            <div>
                                <div class="detail-label">Per√≠odo de vigencia</div>
                                <div class="detail-value" th:text="${#temporals.format(p.fechaInicio, 'dd MMM yyyy') + ' - ' + #temporals.format(p.fechaFin, 'dd MMM yyyy')}">01 Ene - 31 Ene</div>
                            </div>
                        </div>
                        <div class="detail-row">
                            <span>üë•</span>
                            <div>
                                <div class="detail-label">Membres√≠as aplicables</div>
                                <div class="membership-tags">
                                    <span class="membership-tag" th:each="m : ${p.membresias}" th:text="${m.membresia}">Mensual</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="usage-section">
                        <div class="usage-header">
                            <span class="detail-label">Usos de la promoci√≥n</span>
                            <span class="usage-count" th:text="${p.usados + ' / ' + p.maxUsos}">0 / 100</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" th:style="${'width:' + ((p.usados * 100) / p.maxUsos) + '%'}"></div>
                        </div>
                        <div class="usage-subtitle" th:text="(${p.maxUsos} - ${p.usados}) + ' usos disponibles'">0 usos disponibles</div>
                    </div>
                    <div class="promo-actions">
                        <button class="btn-action" type="button"
                                th:attr="
                                  data-id=${p.id},
                                  data-nombre=${p.nombre},
                                  data-tipo=${p.tipo.name()},
                                  data-descripcion=${p.descripcion},
                                  data-valor=${p.valor},
                                  data-maxusos=${p.maxUsos},
                                  data-inicio=${#temporals.format(p.fechaInicio, 'yyyy-MM-dd')},
                                  data-fin=${#temporals.format(p.fechaFin, 'yyyy-MM-dd')}
                                "
                                onclick="openEditFromButton(this)"><span class="emoji">‚úèÔ∏è</span><span>Editar</span></button>
                        <form th:action="@{'/promociones/' + ${p.id} + '/toggle'}" method="post">
                            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <button class="btn-action" type="submit">
                                <span class="emoji" th:text="${p.estado.name() == 'ACTIVE' ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}"></span>
                                <span th:text="${p.estado.name() == 'ACTIVE' ? 'Desactivar' : 'Activar'}"></span>
                            </button>
                        </form>
                        <form th:action="@{'/promociones/' + ${p.id} + '/delete'}" method="post" onsubmit="return confirm('¬øEliminar esta promoci√≥n?');">
                            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <button class="btn-action delete" type="submit"><span class="emoji">üóëÔ∏è</span><span>Eliminar</span></button>
                        </form>
                    </div>
                </div>
            </div>
        </section>
        <section>
            <h2 class="section-title">Promociones Expiradas</h2>
            <div class="promo-grid">
                <div th:each="p : ${expiradas}" class="promo-card" th:attr="id=${'promo-' + p.id}">
                    <div class="promo-header">
                        <div class="promo-title-wrapper" th:with="now=${hoy}">
                            <h3 class="promo-title" th:text="${p.nombre}">Nombre</h3>
                            <span class="badge badge-completed">Concluida</span>
                            <span class="chip-expired">Expirada</span>
                        </div>
                    </div>
                    <p class="promo-description" th:text="${p.descripcion}">Descripci√≥n</p>
                    <div class="promo-value">
                        <div class="value-icon" th:text="${p.tipo.name() == 'PERCENTAGE' ? '%' : 'S/'}">%</div>
                        <div class="value-amount" th:text="${p.tipo.name() == 'PERCENTAGE' ? '%' + p.valor : 'S/ ' + p.valor}">$20</div>
                        <div class="value-label" th:text="${p.tipo.name() == 'PERCENTAGE' ? 'DESCUENTO' : 'AHORRO'}">DESCUENTO</div>
                    </div>
                    <div class="promo-actions">
                        <button class="btn-action" type="button"
                                th:attr="
                                  data-id=${p.id},
                                  data-nombre=${p.nombre},
                                  data-tipo=${p.tipo.name()},
                                  data-descripcion=${p.descripcion},
                                  data-valor=${p.valor},
                                  data-maxusos=${p.maxUsos},
                                  data-inicio=${#temporals.format(p.fechaInicio, 'yyyy-MM-dd')},
                                  data-fin=${#temporals.format(p.fechaFin, 'yyyy-MM-dd')}
                                "
                                onclick="openEditFromButton(this)"><span class="emoji">‚úèÔ∏è</span><span>Editar</span></button>
                        <button class="btn-action" type="button"
                                th:attr="
                                  data-id=${p.id},
                                  data-nombre=${p.nombre},
                                  data-tipo=${p.tipo.name()},
                                  data-descripcion=${p.descripcion},
                                  data-valor=${p.valor},
                                  data-maxusos=${p.maxUsos},
                                  data-inicio=${#temporals.format(hoy, 'yyyy-MM-dd')},
                                  data-fin=${#temporals.format(hoy.plusDays(30), 'yyyy-MM-dd')}
                                "
                                onclick="openReactivateFromButton(this)"><span class="emoji">‚ñ∂Ô∏è</span><span>Reactivar</span></button>
                        <form th:action="@{'/promociones/' + ${p.id} + '/delete'}" method="post" onsubmit="return confirm('¬øEliminar esta promoci√≥n?');">
                            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <button class="btn-action delete" type="submit"><span class="emoji">üóëÔ∏è</span><span>Eliminar</span></button>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <section>
            <h2 class="section-title">Promociones Inactivas</h2>
            <div class="promo-grid">
                <div th:each="p : ${inactivas}" class="promo-card" th:attr="id=${'promo-' + p.id}">
                    <div class="promo-header">
                        <div class="promo-title-wrapper" th:with="now=${hoy}">
                            <h3 class="promo-title" th:text="${p.nombre}">Nombre</h3>
                            <span class="badge"
                                  th:classappend="
                                    ${now.isBefore(p.fechaInicio)} ? ' badge-pending' :
                                    (${now.isAfter(p.fechaFin)} ? ' badge-completed' : ' badge-inactive')
                                  "
                                  th:text="
                                    ${now.isBefore(p.fechaInicio)} ? 'Pendiente' :
                                    (${now.isAfter(p.fechaFin)} ? 'Concluida' : 'Inactiva')
                                  ">Estado</span>
                            <span class="chip-expired" th:if="${now.isAfter(p.fechaFin)}">Expirada</span>
                        </div>
                    </div>
                    <p class="promo-description" th:text="${p.descripcion}">Descripci√≥n</p>
                    <div class="promo-value">
                        <div class="value-icon" th:text="${p.tipo.name() == 'PERCENTAGE' ? '%' : 'S/'}">%</div>
                        <div class="value-amount" th:text="${p.tipo.name() == 'PERCENTAGE' ? '%' + p.valor : 'S/ ' + p.valor}">$20</div>
                        <div class="value-label" th:text="${p.tipo.name() == 'PERCENTAGE' ? 'DESCUENTO' : 'AHORRO'}">DESCUENTO</div>
                    </div>
                    <div class="promo-actions">
                        <button class="btn-action" type="button"
                                th:attr="
                                  data-id=${p.id},
                                  data-nombre=${p.nombre},
                                  data-tipo=${p.tipo.name()},
                                  data-descripcion=${p.descripcion},
                                  data-valor=${p.valor},
                                  data-maxusos=${p.maxUsos},
                                  data-inicio=${#temporals.format(p.fechaInicio, 'yyyy-MM-dd')},
                                  data-fin=${#temporals.format(p.fechaFin, 'yyyy-MM-dd')}
                                "
                                onclick="openEditFromButton(this)"><span class="emoji">‚úèÔ∏è</span><span>Editar</span></button>
                        <form th:action="@{'/promociones/' + ${p.id} + '/toggle'}" method="post">
                            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <button class="btn-action" type="submit"><span class="emoji">‚ñ∂Ô∏è</span><span>Activar</span></button>
                        </form>
                        <form th:action="@{'/promociones/' + ${p.id} + '/delete'}" method="post" onsubmit="return confirm('¬øEliminar esta promoci√≥n?');">
                            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <button class="btn-action delete" type="submit"><span class="emoji">üóëÔ∏è</span><span>Eliminar</span></button>
                        </form>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <button class="fab" onclick="openModalCreate()">Ôºã</button>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Nueva Promoci√≥n</h2>
                <button class="btn-close" onclick="closeModal()">&times;</button>
            </div>
            <form class="modal-body" id="promoForm" th:action="@{/promociones}" method="post">
                <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Nombre de la Promoci√≥n <span class="required">*</span></label>
                        <input type="text" class="form-input" name="nombre" id="promoName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tipo de Descuento <span class="required">*</span></label>
                        <select class="form-select" name="tipo" id="discountType" required onchange="updateDiscountPrefix()">
                            <option value="">Seleccionar</option>
                            <option value="PERCENTAGE">Porcentaje (%)</option>
                            <option value="AMOUNT">Monto Fijo ($)</option>
                        </select>
                    </div>
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Descripci√≥n</label>
                    <textarea class="form-textarea" name="descripcion" id="description" placeholder="Descripci√≥n de la promoci√≥n"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Valor del Descuento <span class="required">*</span></label>
                        <div style="position:relative;">
                            <span id="discountPrefix" style="position:absolute;left:.875rem;top:50%;transform:translateY(-50%);color:#6b7280;">%</span>
                            <input type="number" step="0.01" class="form-input" style="padding-left:2rem;" name="valor" id="discountValue" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">N√∫mero M√°ximo de Usos <span class="required">*</span></label>
                        <input type="number" class="form-input" name="maxUsos" id="maxUses" min="1" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Fecha de Inicio <span class="required">*</span></label>
                        <input type="date" class="form-input" name="fechaInicio" id="startDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fecha de Fin <span class="required">*</span></label>
                        <input type="date" class="form-input" name="fechaFin" id="endDate" required>
                    </div>
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Membres√≠as Aplicables <span class="required">*</span></label>
                    <div class="checkbox-group">
                        <label class="checkbox-label"><input type="checkbox" class="form-checkbox" name="membership" value="Mensual"> <span>Mensual</span></label>
                        <label class="checkbox-label"><input type="checkbox" class="form-checkbox" name="membership" value="Trimestral"> <span>Trimestral</span></label>
                        <label class="checkbox-label"><input type="checkbox" class="form-checkbox" name="membership" value="Semestral"> <span>Semestral</span></label>
                        <label class="checkbox-label"><input type="checkbox" class="form-checkbox" name="membership" value="Anual"> <span>Anual</span></label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                    <button type="submit" id="modalSubmitButton" class="btn btn-primary">Crear Promoci√≥n</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function openModal(){ document.getElementById('modalOverlay').style.display='flex'; }
        function closeModal(){ document.getElementById('modalOverlay').style.display='none'; }
        function openModalCreate(){
            const form = document.getElementById('promoForm');
            form.setAttribute('action', '/promociones');
            document.getElementById('modalTitle').textContent = 'Nueva Promoci√≥n';
            form.reset();
            updateDiscountPrefix();
            const submitBtn = document.getElementById('modalSubmitButton');
            if (submitBtn) submitBtn.textContent = 'Crear Promoci√≥n';
            openModal();
        }
        function updateDiscountPrefix(){
            const type = document.getElementById('discountType').value;
            const prefix = document.getElementById('discountPrefix');
            if(type === 'PERCENTAGE'){ prefix.textContent = '%'; }
            else if(type === 'AMOUNT'){ prefix.textContent = 'S/'; }
        }
        function openEditFromButton(btn){
            const form = document.getElementById('promoForm');
            const id = btn.dataset.id;
            form.setAttribute('action', '/promociones/' + id + '/editar');
            document.getElementById('modalTitle').textContent = 'Editar Promoci√≥n';
            document.getElementById('promoName').value = btn.dataset.nombre;
            document.getElementById('discountType').value = btn.dataset.tipo;
            document.getElementById('description').value = btn.dataset.descripcion || '';
            document.getElementById('discountValue').value = btn.dataset.valor;
            document.getElementById('maxUses').value = btn.dataset.maxusos;
            document.getElementById('startDate').value = btn.dataset.inicio;
            document.getElementById('endDate').value = btn.dataset.fin;
            updateDiscountPrefix();
            // Si en el futuro se pasa la lista de membres√≠as por data-*, aqu√≠ se puede mapear.
            // Por ahora se dejan como est√°n y el usuario puede re-seleccionarlas.
            const submitBtn = document.getElementById('modalSubmitButton');
            if (submitBtn) submitBtn.textContent = 'Guardar cambios';
            openModal();
        }

        function openReactivateFromButton(btn){
            const form = document.getElementById('promoForm');
            const id = btn.dataset.id;
            form.setAttribute('action', '/promociones/' + id + '/reactivar');
            document.getElementById('modalTitle').textContent = 'Reactivar Promoci√≥n';
            document.getElementById('promoName').value = btn.dataset.nombre;
            document.getElementById('discountType').value = btn.dataset.tipo;
            document.getElementById('description').value = btn.dataset.descripcion || '';
            document.getElementById('discountValue').value = btn.dataset.valor;
            document.getElementById('maxUses').value = btn.dataset.maxusos;
            document.getElementById('startDate').value = btn.dataset.inicio;
            document.getElementById('endDate').value = btn.dataset.fin;
            updateDiscountPrefix();
            const submitBtn = document.getElementById('modalSubmitButton');
            if (submitBtn) submitBtn.textContent = 'Reactivar';
            openModal();
        }
    </script>
            </main>
        </div>
    </div>
    <!-- Cargar el script del sidebar -->
    <script th:src="@{/sidebar.js}"></script>
    <!-- Inicializar el sidebar despu√©s de cargar el DOM -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Asegurarse de que el bot√≥n del men√∫ est√© configurado correctamente
            const menuButton = document.getElementById('menu-button');
            if (menuButton) {
                menuButton.addEventListener('click', function() {
                    document.documentElement.classList.toggle('sidebar-expanded');
                    localStorage.setItem('sidebarExpanded', document.documentElement.classList.contains('sidebar-expanded'));
                });
            }
        });
    </script>
</body>
</html>
