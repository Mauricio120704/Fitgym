<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cupos de Clases</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" th:href="@{/Estilos/sidebar-common.css}">
    <link rel="stylesheet" th:href="@{/Estilos/custom-select.css}">
    <link rel="stylesheet" th:href="@{/css/buttons.css}">
    <style>
        /* Mejorar visualización de selects/dropdowns */
        select {
            position: relative;
            z-index: 10;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            border: 2px solid #e5e7eb;
            transition: all 0.2s ease;
            background-color: white;
            box-sizing: border-box;
        }
        
        select:hover {
            border-color: #d1d5db;
            background-color: white;
        }
        
        select:focus {
            z-index: 50;
            border-color: #f97316;
            background-color: white;
            outline: 2px solid #f97316;
            outline-offset: 2px;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }
        
        select:active {
            background-color: white;
        }
        
        /* Estilos para las opciones del dropdown */
        select option {
            background-color: white;
            color: #1f2937;
            padding: 12px 8px;
            border: 1px solid #e5e7eb;
            line-height: 1.6;
            margin: 2px 0;
        }
        
        select option:first-child {
            background-color: #f9fafb;
            color: #6b7280;
            font-weight: 500;
        }
        
        select option:hover {
            background-color: #f3f4f6;
            color: #1f2937;
        }
        
        select option:checked {
            background: linear-gradient(#f97316, #f97316);
            background-color: #f97316;
            color: white;
            font-weight: 500;
        }
        
        /* Contenedor relativo para mejor control */
        select {
            width: 100%;
            min-height: 44px;
        }
    </style>
    <script>
        (function() {
            const expanded = localStorage.getItem('sidebarExpanded') === 'true';
            if (expanded) {
                document.documentElement.style.setProperty('--sidebar-width', '16rem');
            } else {
                document.documentElement.style.setProperty('--sidebar-width', '5rem');
            }
        })();
    </script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="flex h-screen bg-gray-200">
    <th:block th:replace="fragments/sidebar :: sidebar('clases')"></th:block>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex justify-between items-center p-4 bg-white border-b shadow-sm">
                <div class="flex items-center gap-4">
                    <button id="menu-button" class="text-gray-600 hover:text-gray-800 focus:outline-none">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <div class="text-xl font-semibold text-gray-800">Cupos de Clases</div>
                </div>
            </header>

            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                <div class="container mx-auto">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">Gestión de Clases</h1>
                    <p class="text-gray-600 mb-6">Administra los cupos y horarios de las clases</p>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-sm font-medium text-gray-500">Total Clases</h3>
                            <p class="text-2xl font-bold text-gray-800 mt-2" th:text="${totalClases}">0</p>
                            <p class="text-sm text-gray-500 mt-1">Programadas</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-sm font-medium text-gray-500">Clases Llenas</h3>
                            <p class="text-2xl font-bold text-orange-500 mt-2" th:text="${clasesLlenas}">0</p>
                            <p class="text-sm text-gray-500 mt-1">Sin cupos disponibles</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-sm font-medium text-gray-500">Total Cupos</h3>
                            <p class="text-2xl font-bold text-gray-800 mt-2" th:text="${totalCupos}">0</p>
                            <p class="text-sm text-gray-500 mt-1">Capacidad total</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-4">
                            <h2 class="text-lg font-semibold text-gray-800">Clases Programadas</h2>
                            <div class="flex flex-col gap-4 w-full md:grid md:grid-cols-[auto,1fr,auto] md:items-center md:gap-6">
                                <!-- Grupo izquierda: Filtros -->
                                <div class="flex items-center gap-6">
                                    <a th:href="@{/clases(periodo='hoy', buscar=${buscarActual})}"
                                       th:classappend="${periodo == 'hoy' ? ' text-orange-600 border-orange-500 font-medium' : ' text-gray-600 hover:text-gray-800 border-transparent'}"
                                       class="h-9 inline-flex items-center px-2 text-sm border-b-2 transition-colors whitespace-nowrap">Hoy</a>
                                    <a th:href="@{/clases(periodo='semana', buscar=${buscarActual})}"
                                       th:classappend="${periodo == 'semana' ? ' text-orange-600 border-orange-500 font-medium' : ' text-gray-600 hover:text-gray-800 border-transparent'}"
                                       class="h-9 inline-flex items-center px-2 text-sm border-b-2 transition-colors whitespace-nowrap">Esta semana</a>
                                    <a th:href="@{/clases(periodo='mes', buscar=${buscarActual})}"
                                       th:classappend="${periodo == 'mes' ? ' text-orange-600 border-orange-500 font-medium' : ' text-gray-600 hover:text-gray-800 border-transparent'}"
                                       class="h-9 inline-flex items-center px-2 text-sm border-b-2 transition-colors whitespace-nowrap">Este mes</a>
                                    <a th:href="@{/clases(periodo='todos', buscar=${buscarActual})}"
                                       th:classappend="${periodo == 'todos' ? ' text-orange-600 border-orange-500 font-medium' : ' text-gray-600 hover:text-gray-800 border-transparent'}"
                                       class="h-9 inline-flex items-center px-2 text-sm border-b-2 transition-colors whitespace-nowrap">Todas</a>
                                </div>

                                <!-- Grupo centro: Navegación semanal -->
                                <div class="hidden md:flex md:justify-center">
                                    <div th:if="${periodo == 'semana'}" class="flex items-center gap-2">
                                        <div class="inline-flex items-center bg-gray-50 rounded-lg border border-gray-200 h-9 overflow-hidden">
                                            <a th:href="@{/clases(periodo='semana', buscar=${buscarActual}, fechaInicio=${#temporals.format(semanaAnterior, 'yyyy-MM-dd')})}"
                                               class="h-9 w-9 grid place-items-center hover:bg-gray-100 transition-colors" title="Semana anterior">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                                </svg>
                                            </a>
                                            <span class="text-sm font-medium text-gray-700 whitespace-nowrap px-3 leading-9 border-l border-r border-gray-200">
                                                <span th:text="${#temporals.format(fechaInicio, 'd MMM')} + ' - ' + ${#temporals.format(fechaFin, 'd MMM yyyy')}"></span>
                                            </span>
                                            <a th:href="@{/clases(periodo='semana', buscar=${buscarActual}, fechaInicio=${#temporals.format(siguienteSemana, 'yyyy-MM-dd')})}"
                                               class="h-9 w-9 grid place-items-center hover:bg-gray-100 transition-colors" title="Siguiente semana">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                                </svg>
                                            </a>
                                        </div>
                                    </div>
                                    <div th:unless="${periodo == 'semana'}" class="h-9"></div>
                                </div>

                                <!-- Grupo derecha: Buscador -->
                                <form th:action="@{/clases}" method="get" class="flex w-full md:w-auto items-stretch h-9">
                                    <input type="hidden" name="periodo" th:value="${periodo}">
                                    <input type="hidden" name="fechaInicio" th:if="${fechaInicio != null}"
                                           th:value="${#temporals.format(fechaInicio, 'yyyy-MM-dd')}">
                                    <div class="flex w-full md:w-72 border rounded-lg overflow-hidden">
                                        <input type="text" name="buscar" th:value="${buscarActual}"
                                               placeholder="Buscar clases..."
                                               class="px-4 flex-1 focus:outline-none h-9">
                                        <button type="submit" class="px-3 bg-orange-500 text-white hover:bg-orange-600 grid place-items-center">
                                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="text-xs text-gray-500 uppercase bg-gray-50">
                                        <th class="px-4 py-3">Clase</th>
                                        <th class="px-4 py-3">Instructor</th>
                                        <th class="px-4 py-3">Fecha y Hora</th>
                                        <th class="px-4 py-3">Duración</th>
                                        <th class="px-4 py-3">Cupos</th>
                                        <th class="px-4 py-3">Estado</th>
                                        <th class="px-4 py-3">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody class="text-sm text-gray-700">
                                    <!-- Mensaje cuando no hay resultados para el filtro aplicado -->
                                    <tr th:if="${#lists.isEmpty(clases)}">
                                        <td class="px-4 py-6 text-center text-gray-500" colspan="7"
                                            th:text="${buscarActual != null && !#strings.isEmpty(buscarActual) ?
                                                      'No se encontraron clases para el periodo seleccionado que coincidan con ' + buscarActual + '.' :
                                                      'No se encontraron clases para el periodo seleccionado.'}">
                                            No se encontraron clases para el periodo seleccionado.
                                        </td>
                                    </tr>

                                    <tr th:each="clase : ${clases}" class="border-b hover:bg-gray-50" th:data-id="${clase.id}">
                                        <td class="px-4 py-3 font-medium" th:text="${clase.nombre}">Yoga</td>
                                        <td class="px-4 py-3" th:text="${clase.instructor}">María</td>
                                        <td class="px-4 py-3">
                                            <span th:text="${#temporals.format(clase.fecha, 'dd/MM/yyyy')}">15/02/2025</span>
                                            <span th:text="${#temporals.format(clase.hora, 'HH:mm')}">07:00</span>
                                        </td>
                                        <td class="px-4 py-3"><span th:text="${clase.duracion}">60</span> min</td>
                                        <td class="px-4 py-3">
                                            <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs items-center">
                                                <!-- Básico: Gris si no hay cupos, normal si hay -->
                                                <span th:if="${clase.cuposBasico > 0}" class="flex items-center gap-1">
                                                    <span class="font-semibold text-gray-900">Básico:</span>
                                                    <span th:text="${clase.ocupadosBasico}">0</span>/<span th:text="${clase.cuposBasico}">15</span>
                                                </span>
                                                <span th:unless="${clase.cuposBasico > 0}" class="flex items-center gap-1 text-gray-400">
                                                    <span class="font-semibold">Básico:</span>
                                                    <span>-</span>
                                                </span>
                                                <!-- Premium -->
                                                <span class="flex items-center gap-1">
                                                    <span class="font-semibold text-gray-900">Premium:</span>
                                                    <span th:text="${clase.ocupadosPremium}">12</span>/<span th:text="${clase.cuposPremium}">50</span>
                                                </span>
                                                <!-- Elite -->
                                                <span class="flex items-center gap-1">
                                                    <span class="font-semibold text-gray-900">Elite:</span>
                                                    <span th:text="${clase.ocupadosElite}">8</span>/<span th:text="${clase.cuposElite}">0</span>
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-4 py-3">
                                            <span th:if="${(clase.ocupadosPremium + clase.ocupadosElite) >= (clase.cuposPremium + clase.cuposElite)}" 
                                                  class="px-3 py-1 text-xs font-semibold text-red-800 bg-red-200 rounded-full">Llena</span>
                                            <span th:unless="${(clase.ocupadosPremium + clase.ocupadosElite) >= (clase.cuposPremium + clase.cuposElite)}" 
                                                  class="px-3 py-1 text-xs font-semibold text-green-800 bg-green-200 rounded-full">Disponible</span>
                                        </td>
                                        <td class="px-4 py-3">
                                            <div class="btn-group">
                                                <button class="btn btn-primary btn-sm btn-editar-clase" 
                                                        th:data-id="${clase.id}"
                                                        th:data-nombre="${clase.nombre}"
                                                        th:data-instructor="${clase.instructor}"
                                                        th:data-fecha="${#temporals.format(clase.fecha, 'yyyy-MM-dd')}"
                                                        th:data-hora="${#temporals.format(clase.hora, 'HH:mm')}"
                                                        th:data-duracion="${clase.duracion}"
                                                        th:data-cupos-premium="${clase.cuposPremium}"
                                                        th:data-cupos-elite="${clase.cuposElite}"
                                                        th:data-tipo-id="${clase.tipoClaseId}"
                                                        th:data-tipo-nombre="${clase.tipoClaseNombre}"
                                                        th:data-cupos-basico="${clase.cuposBasico}"
                                                        th:data-es-pago="${clase.esPago}"
                                                        th:data-para-todos="${clase.paraTodos}"
                                                        th:data-precio="${clase.precio}"
                                                        title="Editar">
                                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                    </svg>
                                                    <span>Editar</span>
                                                </button>
                                                <button class="btn btn-danger btn-sm btn-eliminar-clase" 
                                                        th:data-id="${clase.id}"
                                                        th:data-nombre="${clase.nombre}"
                                                        title="Eliminar">
                                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                    </svg>
                                                    <span>Eliminar</span>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Paginación -->
                        <div class="mt-4 flex items-center justify-between text-sm text-gray-600" th:if="${totalPages > 1}">
                            <div>
                                <span th:text="|Mostrando ${pageStart} - ${pageEnd} de ${totalClases} clases|">Mostrando 1 - 25 de 100 clases</span>
                            </div>
                            <div class="inline-flex items-center gap-1">
                                <!-- Botón Anterior -->
                                <a th:if="${currentPage > 0}"
                                   th:href="@{/clases(page=${currentPage - 1}, periodo=${periodo}, buscar=${buscarActual}, fechaInicio=${#temporals.format(fechaInicio, 'yyyy-MM-dd')})}"
                                   class="px-3 py-1 border border-gray-300 rounded-l-md bg-white hover:bg-gray-50">Anterior</a>
                                <span th:if="${currentPage == 0}"
                                      class="px-3 py-1 border border-gray-200 rounded-l-md bg-gray-100 text-gray-400 cursor-not-allowed">Anterior</span>

                                <!-- Números de página -->
                                <span th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
                                    <a th:if="${i != currentPage}"
                                       th:href="@{/clases(page=${i}, periodo=${periodo}, buscar=${buscarActual}, fechaInicio=${#temporals.format(fechaInicio, 'yyyy-MM-dd')})}"
                                       th:text="${i + 1}"
                                       class="px-3 py-1 border border-gray-300 bg-white hover:bg-gray-50"></a>
                                    <span th:if="${i == currentPage}"
                                          th:text="${i + 1}"
                                          class="px-3 py-1 border border-orange-500 bg-orange-500 text-white"></span>
                                </span>

                                <!-- Botón Siguiente -->
                                <a th:if="${currentPage < totalPages - 1}"
                                   th:href="@{/clases(page=${currentPage + 1}, periodo=${periodo}, buscar=${buscarActual}, fechaInicio=${#temporals.format(fechaInicio, 'yyyy-MM-dd')})}"
                                   class="px-3 py-1 border border-gray-300 rounded-r-md bg-white hover:bg-gray-50">Siguiente</a>
                                <span th:if="${currentPage >= totalPages - 1}"
                                      class="px-3 py-1 border border-gray-200 rounded-r-md bg-gray-100 text-gray-400 cursor-not-allowed">Siguiente</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Información sobre Membresías -->
                    <div class="mt-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Información sobre Cupos por Membresía</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-lg shadow border border-blue-200">
                                <h3 class="text-xl font-bold text-blue-800 mb-3">Membresía Premium</h3>
                                <p class="text-gray-700">Los miembros Premium pueden reservar cuando haya cupos disponibles, asegurando su lugar en la mayoría de las clases.</p>
                            </div>
                            <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-lg shadow border border-purple-200">
                                <h3 class="text-xl font-bold text-purple-800 mb-3">Membresía Elite</h3>
                                <p class="text-gray-700">Los miembros Elite pueden reservar con mayor prioridad y cuentan con más cupos disponibles en todas las clases.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            <!-- Botón flotante para crear nueva clase -->
            <button id="btn-nueva-clase"
                    class="fab-add"
                    type="button"
                    aria-label="Nueva clase">
                <svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
            </button>
        </div>
    </div>
    <!-- Modal Nueva Clase -->
    <div id="modal-nueva-clase" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-40 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 my-8 z-50">
            <div class="flex justify-between items-center p-6 border-b">
                <h2 class="text-2xl font-bold text-gray-800">Configurar Nueva Clase</h2>
                <button id="modal-close" class="text-gray-500 hover:text-gray-700">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="form-nueva-clase" class="p-6 space-y-4 max-h-[calc(90vh-120px)] overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Instructor *</label>
                        <div class="relative">
                            <select id="clase-instructor" required
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-white">
                                <option value="">Seleccionar instructor</option>
                                <option th:each="inst : ${instructores}"
                                        th:value="${inst.nombre + ' ' + inst.apellido}"
                                        th:text="${inst.nombre + ' ' + inst.apellido}">
                                </option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Tipo de Clase *</label>
                        <div class="flex gap-2">
                            <div class="relative flex-1">
                                <select id="clase-tipo" required
                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-white">
                                    <option value="">Seleccionar tipo</option>
                                    <option value="nuevo">+ Agregar nuevo tipo</option>
                                    <option th:each="t : ${tiposClase}"
                                            th:if="${!(#strings.equalsIgnoreCase(t.nombre, 'Otra'))}"
                                            th:value="${t.id}"
                                            th:text="${t.nombre}">
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div id="nuevo-tipo-wrapper" class="mt-2 hidden">
                            <div class="flex gap-2">
                                <input type="text" id="nuevo-tipo-nombre" placeholder="Nombre del nuevo tipo"
                                       class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                                <button type="button" id="crear-tipo-btn" class="px-4 py-3 bg-gray-800 text-white rounded-lg hover:bg-gray-900">Crear</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Fecha *</label>
                        <input type="date" id="clase-fecha" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Hora *</label>
                        <input type="time" id="clase-hora" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Duración (min) *</label>
                        <input type="number" id="clase-duracion" min="10" step="5" value="60" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Cupos por Tipo de Membresía</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Membresía Básico *</label>
                            <input type="number" id="clase-cupos-basico" min="0" step="1" value="0" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Membresía Premium *</label>
                            <input type="number" id="clase-cupos-premium" min="0" step="1" value="15" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Membresía Elite *</label>
                            <input type="number" id="clase-cupos-elite" min="0" step="1" value="20" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Clase de pago</label>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="clase-es-pago" class="h-4 w-4 text-orange-500 border-gray-300 rounded">
                            <span class="text-sm text-gray-600">Si está activado, la clase tendrá un precio y se cobrará a Básico/no miembros según la configuración.</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Precio (S/)</label>
                        <input type="number" id="clase-precio" min="0" step="0.1" placeholder="0.00"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Disponibilidad</label>
                    <div class="flex flex-col md:flex-row gap-3">
                        <label class="inline-flex items-center">
                            <input type="radio" name="clase-disponibilidad" id="clase-solo-miembros" value="soloMiembros" class="h-4 w-4 text-orange-500 border-gray-300" checked>
                            <span class="ml-2 text-sm text-gray-700">Solo miembros (Premium/Elite)</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="clase-disponibilidad" id="clase-para-todos" value="paraTodos" class="h-4 w-4 text-orange-500 border-gray-300">
                            <span class="ml-2 text-sm text-gray-700">Para todos (permite compra de cupos para Básico y no miembros)</span>
                        </label>
                    </div>
                </div>
            </form>
            <div class="flex justify-end gap-3 p-6 border-t bg-gray-50">
                <button type="button" id="modal-cancel" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">
                    Cancelar
                </button>
                <button type="button" id="modal-save" class="px-6 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition">
                    Guardar Clase
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Confirmación Eliminar -->
    <div id="modal-confirmar-eliminar" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4 p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">¿Eliminar clase?</h3>
            <p class="text-gray-600 mb-6" id="confirmar-eliminar-mensaje"></p>
            <div class="flex justify-end gap-3">
                <button id="confirmar-eliminar-cancelar" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">
                    Cancelar
                </button>
                <button id="confirmar-eliminar-aceptar" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
                    Eliminar
                </button>
            </div>
        </div>
    </div>

    <script th:src="@{/sidebar.js}"></script>
    <script th:src="@{/custom-select.js}"></script>
    <script>
        // Modal Nueva Clase
        const btnNuevaClase = document.getElementById('btn-nueva-clase');
        const modal = document.getElementById('modal-nueva-clase');
        const modalClose = document.getElementById('modal-close');
        const modalCancel = document.getElementById('modal-cancel');
        const modalSave = document.getElementById('modal-save');
        const form = document.getElementById('form-nueva-clase');
        const tipoSelect = document.getElementById('clase-tipo');
        const nuevoTipoWrapper = document.getElementById('nuevo-tipo-wrapper');
        const nuevoTipoNombre = document.getElementById('nuevo-tipo-nombre');
        const crearTipoBtn = document.getElementById('crear-tipo-btn');
        let claseEditandoId = null;

        function openModal(editando = false) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.style.overflow = 'hidden';
            
            // Cambiar título del modal
            const titulo = modal.querySelector('h2');
            const btnGuardar = document.getElementById('modal-save');
            if (editando) {
                titulo.textContent = 'Editar Clase';
                btnGuardar.textContent = 'Actualizar Clase';
            } else {
                titulo.textContent = 'Configurar Nueva Clase';
                btnGuardar.textContent = 'Guardar Clase';
            }
            // Reset de Tipo de clase en apertura de modal
            if (!editando && tipoSelect) {
                tipoSelect.value = '';
                if (nuevoTipoWrapper) { nuevoTipoWrapper.classList.add('hidden'); }
                if (nuevoTipoNombre) { nuevoTipoNombre.value = ''; }
                const esPagoInput = document.getElementById('clase-es-pago');
                const precioInput = document.getElementById('clase-precio');
                const soloMiembrosRadio = document.getElementById('clase-solo-miembros');
                const paraTodosRadio = document.getElementById('clase-para-todos');
                if (esPagoInput) esPagoInput.checked = false;
                if (precioInput) precioInput.value = '';
                if (soloMiembrosRadio) soloMiembrosRadio.checked = true;
                if (paraTodosRadio) paraTodosRadio.checked = false;
            }
            // Aplicar siempre el estado correcto de campos según la disponibilidad seleccionada
            actualizarDisponibilidadCampos();
        }

        function actualizarDisponibilidadCampos() {
            const cuposBasicoInput = document.getElementById('clase-cupos-basico');
            const esPagoInput = document.getElementById('clase-es-pago');
            const precioInput = document.getElementById('clase-precio');
            const soloMiembrosRadio = document.getElementById('clase-solo-miembros');
            const paraTodosRadio = document.getElementById('clase-para-todos');

            if (!soloMiembrosRadio || !paraTodosRadio) {
                return;
            }

            const soloMiembros = soloMiembrosRadio.checked;

            if (soloMiembros) {
                // Solo miembros Premium/Elite: bloquear Básico y pagos
                if (cuposBasicoInput) {
                    cuposBasicoInput.value = '0';
                    cuposBasicoInput.disabled = true;
                    cuposBasicoInput.classList.add('bg-gray-100', 'cursor-not-allowed');
                }
                if (esPagoInput) {
                    esPagoInput.checked = false;
                    esPagoInput.disabled = true;
                }
                if (precioInput) {
                    precioInput.value = '';
                    precioInput.disabled = true;
                    precioInput.classList.add('bg-gray-100', 'cursor-not-allowed');
                }
            } else {
                // Para todos: permitir configurar Básico y pagos
                if (cuposBasicoInput) {
                    cuposBasicoInput.disabled = false;
                    cuposBasicoInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
                }
                if (esPagoInput) {
                    esPagoInput.disabled = false;
                }
                if (precioInput) {
                    precioInput.disabled = false;
                    precioInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
                }
            }
        }

        function closeModal() {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = '';
            form.reset();
            claseEditandoId = null;
        }

        if (btnNuevaClase) btnNuevaClase.addEventListener('click', () => openModal(false));
        if (modalClose) modalClose.addEventListener('click', closeModal);
        if (modalCancel) modalCancel.addEventListener('click', closeModal);

        // Manejo de Tipo de Clase
        if (tipoSelect) {
            tipoSelect.addEventListener('change', () => {
                if (tipoSelect.value === 'nuevo') {
                    nuevoTipoWrapper.classList.remove('hidden');
                    nuevoTipoNombre.focus();
                } else {
                    nuevoTipoWrapper.classList.add('hidden');
                }
            });
        }
        if (crearTipoBtn) {
            crearTipoBtn.addEventListener('click', async () => {
                const nombre = (nuevoTipoNombre?.value || '').trim();
                if (!nombre) return;
                try {
                    const resp = await fetch('/clases/tipos', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `nombre=${encodeURIComponent(nombre)}`
                    });
                    if (!resp.ok) throw new Error('Error al crear el tipo');
                    const t = await resp.json();
                    // Agregar opción y seleccionar
                    const opt = document.createElement('option');
                    opt.value = String(t.id);
                    opt.textContent = t.nombre;
                    tipoSelect.add(opt);
                    tipoSelect.value = String(t.id);
                    nuevoTipoNombre.value = '';
                    nuevoTipoWrapper.classList.add('hidden');
                } catch (e) {
                    console.error(e);
                    alert('No se pudo crear el tipo de clase');
                }
            });
        }

        // Cerrar con ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                closeModal();
            }
        });

        // Manejar cambios de disponibilidad (Solo miembros / Para todos)
        const soloMiembrosRadio = document.getElementById('clase-solo-miembros');
        const paraTodosRadio = document.getElementById('clase-para-todos');
        if (soloMiembrosRadio) soloMiembrosRadio.addEventListener('change', actualizarDisponibilidadCampos);
        if (paraTodosRadio) paraTodosRadio.addEventListener('change', actualizarDisponibilidadCampos);

        // No cerrar al hacer click fuera - solo con X o Cancelar
        // (similar a incidencias)

        // Guardar o actualizar clase
        if (modalSave) {
            modalSave.addEventListener('click', (e) => {
                e.preventDefault();
                
                // Validar formulario
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                const claseData = {
                    instructor: document.getElementById('clase-instructor').value,
                    fecha: document.getElementById('clase-fecha').value,
                    hora: document.getElementById('clase-hora').value,
                    duracion: parseInt(document.getElementById('clase-duracion').value),
                    cuposBasico: parseInt(document.getElementById('clase-cupos-basico').value),
                    cuposPremium: parseInt(document.getElementById('clase-cupos-premium').value),
                    cuposElite: parseInt(document.getElementById('clase-cupos-elite').value),
                    ocupadosPremium: 0,
                    ocupadosElite: 0,
                    estado: 'ACTIVA',
                    tipoClaseId: (tipoSelect && tipoSelect.value && tipoSelect.value !== 'nuevo') ? parseInt(tipoSelect.value) : null,
                    tipoClaseNombre: (tipoSelect && tipoSelect.value === 'nuevo') ? (nuevoTipoNombre?.value || '').trim() : undefined,
                    esPago: document.getElementById('clase-es-pago').checked,
                    paraTodos: document.getElementById('clase-para-todos').checked,
                    precio: document.getElementById('clase-precio').value
                };

                // Determinar si es crear o actualizar
                const url = claseEditandoId ? `/clases/${claseEditandoId}` : '/clases/crear';
                const method = claseEditandoId ? 'PUT' : 'POST';

                fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(claseData)
                })
                .then(response => response.json())
                .then(data => {
                    console.log('✅ Clase guardada en BD:', data);
                    closeModal();
                    window.location.reload();
                })
                .catch(error => {
                    console.error('❌ Error al guardar clase:', error);
                    alert('Error al guardar la clase');
                });
            });
        }
        
        // Editar clase
        document.addEventListener('click', (e) => {
            if (e.target.closest('.btn-editar-clase')) {
                const btn = e.target.closest('.btn-editar-clase');
                claseEditandoId = btn.dataset.id;
                
                // Llenar el formulario con los datos
                (function() {
                    const sel = document.getElementById('clase-instructor');
                    const value = btn.dataset.instructor || '';
                    if (sel) {
                        let exists = false;
                        for (let i = 0; i < sel.options.length; i++) {
                            if (sel.options[i].value === value) { exists = true; break; }
                        }
                        if (!exists && value) {
                            const opt = new Option(value, value, true, true);
                            sel.add(opt);
                        } else {
                            sel.value = value;
                        }
                    }
                })();
                document.getElementById('clase-fecha').value = btn.dataset.fecha;
                document.getElementById('clase-hora').value = btn.dataset.hora;
                document.getElementById('clase-duracion').value = btn.dataset.duracion;
                document.getElementById('clase-cupos-basico').value = btn.dataset.cuposBasico || 0;
                document.getElementById('clase-cupos-premium').value = btn.dataset.cuposPremium;
                document.getElementById('clase-cupos-elite').value = btn.dataset.cuposElite;
                // Preseleccionar tipo de clase
                if (tipoSelect) {
                    const tid = btn.dataset.tipoId || '';
                    if (tid) {
                        tipoSelect.value = String(tid);
                    }
                }

                // Cargar flags de pago y disponibilidad
                const esPagoInput = document.getElementById('clase-es-pago');
                const precioInput = document.getElementById('clase-precio');
                const soloMiembrosRadio = document.getElementById('clase-solo-miembros');
                const paraTodosRadio = document.getElementById('clase-para-todos');

                const esPago = btn.dataset.esPago === 'true';
                const paraTodos = btn.dataset.paraTodos === 'true';
                const precio = btn.dataset.precio || '';

                if (esPagoInput) esPagoInput.checked = esPago;
                if (precioInput) precioInput.value = precio;
                if (soloMiembrosRadio) soloMiembrosRadio.checked = !paraTodos;
                if (paraTodosRadio) paraTodosRadio.checked = paraTodos;

                actualizarDisponibilidadCampos();
                openModal(true);
            }
            
            // Eliminar clase
            if (e.target.closest('.btn-eliminar-clase')) {
                const btn = e.target.closest('.btn-eliminar-clase');
                const claseId = btn.dataset.id;
                const nombre = btn.dataset.nombre;
                
                // Mostrar modal de confirmación
                const modalConfirmar = document.getElementById('modal-confirmar-eliminar');
                const mensajeConfirmar = document.getElementById('confirmar-eliminar-mensaje');
                const btnAceptar = document.getElementById('confirmar-eliminar-aceptar');
                const btnCancelar = document.getElementById('confirmar-eliminar-cancelar');
                
                mensajeConfirmar.textContent = `¿Estás seguro de eliminar la clase "${nombre}"? Esta acción no se puede deshacer.`;
                modalConfirmar.classList.remove('hidden');
                modalConfirmar.classList.add('flex');
                document.body.style.overflow = 'hidden';
                
                // Función para cerrar modal
                const cerrarModal = () => {
                    modalConfirmar.classList.add('hidden');
                    modalConfirmar.classList.remove('flex');
                    document.body.style.overflow = '';
                };
                
                // Cancelar
                btnCancelar.onclick = cerrarModal;
                
                // Aceptar
                btnAceptar.onclick = () => {
                    cerrarModal();
                    
                    fetch(`/clases/${claseId}`, {
                        method: 'DELETE'
                    })
                    .then(response => {
                        if (response.ok) {
                            console.log('✅ Clase eliminada');
                            window.location.reload();
                        } else {
                            throw new Error('Error al eliminar');
                        }
                    })
                    .catch(error => {
                        console.error('❌ Error:', error);
                        alert('Error al eliminar la clase');
                    });
                };
            }
        });
        
        // Función para agregar clase a la tabla
        function agregarClaseATabla(clase) {
            const tbody = document.querySelector('.classes-table tbody, table tbody');
            if (!tbody) return;
            
            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-gray-50';
            
            // Formatear fecha
            const fechaObj = new Date(clase.fecha + 'T00:00:00');
            const fechaFormateada = fechaObj.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            
            const totalOcupados = clase.ocupadosPremium + clase.ocupadosElite;
            const totalCupos = clase.cuposPremium + clase.cuposElite;
            const estaLlena = totalOcupados >= totalCupos;
            
            row.innerHTML = `
                <td class="px-4 py-3 font-medium">${clase.nombre}</td>
                <td class="px-4 py-3">${clase.instructor}</td>
                <td class="px-4 py-3">
                    <span>${fechaFormateada}</span>
                    <span>${clase.hora}</span>
                </td>
                <td class="px-4 py-3">${clase.duracion} min</td>
                <td class="px-4 py-3">
                    ${clase.cuposPremium} / ${clase.cuposElite}
                </td>
                <td class="px-4 py-3">
                    <div class="font-semibold">
                        ${totalOcupados}/${totalCupos}
                    </div>
                    <div class="text-xs text-gray-500">
                        Premium: ${clase.ocupadosPremium} | Elite: ${clase.ocupadosElite}
                    </div>
                </td>
                <td class="px-4 py-3">
                    <span class="px-3 py-1 text-xs font-semibold ${estaLlena ? 'text-red-800 bg-red-200' : 'text-green-800 bg-green-200'} rounded-full">
                        ${estaLlena ? 'Llena' : 'Disponible'}
                    </span>
                </td>
            `;
            
            // Agregar al inicio de la tabla
            tbody.insertBefore(row, tbody.firstChild);
            
            // Actualizar estadísticas
            actualizarEstadisticasClases();
        }
        
        function actualizarEstadisticasClases() {
            const rows = document.querySelectorAll('table tbody tr');
            const total = rows.length;
            
            // Actualizar total de clases
            const stats = document.querySelectorAll('.grid.grid-cols-1.md\\:grid-cols-3 .bg-white');
            if (stats[0]) stats[0].querySelector('.text-2xl').textContent = total;
        }
    </script>
</body>
</html>
